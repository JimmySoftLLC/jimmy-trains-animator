<!DOCTYPE html>
<html>

<head>
    <title>Animator - Bandstand</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/mui.min.css" />
    <script src="/mui.min.js"></script>
</head>

<body>
    <div id="modalEl"></div>
    <div class="mui-container">
        <h1>Animator - Bandstand</h1>
        <p style="padding-top:0.5rem;">
            Use this web app to control and setup your animator - Bandstand
            product. Have fun animating.
        </p>
        <button id="leftButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="left"
            data-url="/mode">Left</button>
        <button id="rightButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="right"
            data-url="/mode">Right</button>
        <ul class="mui-tabs__bar">
            <li class="mui--is-active">
                <a data-mui-toggle="tab" data-mui-controls="animations">Animations</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="my_animations">my animations</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="settings">Settings</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="tables">Animation tables</a>
            </li>
        </ul>
        <div class="mui-tabs__pane mui--is-active" id="animations" style="padding-top:0.5rem;">
            <button class="mui-btn mui-btn--primary animator-action" data-value="random built in" data-url="/animation"
                type="button">
                Random only built in sound tracks
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="random my" data-url="/animation"
                type="button">
                Random only my sound tracks
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="random all" data-url="/animation"
                type="button">
                Random all sound tracks
            </button>
            <h2>Built in sound tracks:</h2>
            <div id="builtInTracksContainer"></div>
            <h2>Animation settings:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_on" data-url="/mode"
                    type="button">
                    Continuous Mode On
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_off" data-url="/mode"
                    type="button">
                    Continuous Mode Off
                </button>
            </div>
        </div>
        <div class="mui-tabs__pane" id="my_animations" style="padding-top:0.5rem;">
            <h2>My sound tracks:</h2>
            <div id="myTracksContainer"></div>
            <h2>Instructions on how to add your own sound tracks:</h2>
            <p>
                You can create your own sound track files by putting wav files in the folder called
                "customers_owned_music" on the microSD card that is inserted
                in your animator. The files must be named with only lower case letters, numbers and spaces. For example
                "white christmas". The files must be wav files encoded with a sample rate of 22050Hz and a sample format
                of 16 bits.
                You can create files of this type using Audacity, a free application.
            </p>
            <p>
                Once you have your files on the microSD card reinsert it into the animator and power it back on. The
                animator will scan for new files and populate the web page with your sound tracks. Next you animate them
                by selecting one of your sound tracks and follow the spoken instructions.
            </p>
            <h2>Animation timing:</h2>
            <p>
                Time stamp mode allows you to change your animation timing. Once time stamp mode is turned on press the
                left button to start your animation. Once the sound track starts press the right button for each point
                that you want an animation change. Time your button presses to key moments in the sound track. Continue
                to do this until the animation finishes. Then
                timestamp mode will be automatically turned off and your animation will be ready.
            </p>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="timestamp_mode_on" data-url="/mode"
                    type="button">
                    Timestamp Mode On
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="timestamp_mode_off"
                    data-url="/mode" type="button">
                    Timestamp Mode Off
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="reset_animation_timing_to_defaults"
                    data-url="/defaults" type="button">
                    Reset animation timing to factory defaults
                </button>
            </div>
        </div>
        <div class="mui-tabs__pane" id="settings">
            <h2>Platform positions:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S00" data-url="/lights"
                    type="button">
                    All 0
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S090" data-url="/lights"
                    type="button">
                    All 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S0180" data-url="/lights"
                    type="button">
                    All 180
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S190" data-url="/lights"
                    type="button">
                    Servo 1 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S290" data-url="/lights"
                    type="button">
                    Servo 2 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S390" data-url="/lights"
                    type="button">
                    Servo 3 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S490" data-url="/lights"
                    type="button">
                    Servo 4 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S590" data-url="/lights"
                    type="button">
                    Servo 5 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S690" data-url="/lights"
                    type="button">
                    Servo 6 90
                </button>
            </div>
            <h2>Test lights:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L1255" data-url="/lights"
                    type="button">
                    Spot 1
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L2255" data-url="/lights"
                    type="button">
                    Spot 2
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L3255" data-url="/lights"
                    type="button">
                    Spot 3
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L4255" data-url="/lights"
                    type="button">
                    Spot 4
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L5255" data-url="/lights"
                    type="button">
                    Spot 5
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="L00,L6255" data-url="/lights"
                    type="button">
                    Spot 6
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B0" data-url="/lights"
                    type="button">
                    Off
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B20" data-url="/lights"
                    type="button">
                    20
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B40" data-url="/lights"
                    type="button">
                    40
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B60" data-url="/lights"
                    type="button">
                    60
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B80" data-url="/lights"
                    type="button">
                    80
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B100" data-url="/lights"
                    type="button">
                    100
                </button>
            </div>
            <h2>Volume:</h2>
            <button class="mui-btn mui-btn--primary animator-action" data-value="volume_pot_on" data-url="/speaker"
                type="button">
                Volume Pot On
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="volume_pot_off" data-url="/speaker"
                type="button">
                Volume Pot Off
            </button>
            <div class="mui-textfield">
                <input class="input" id="volume" type="number" disabled>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume10">
                    Volume 10
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume20">
                    Volume 20
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume30">
                    Volume 30
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume40">
                    Volume 40
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume50">
                    Volume 50
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume60">
                    Volume 60
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume70">
                    Volume 70
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume80">
                    Volume 80
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume90">
                    Volume 90
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume100">
                    Volume 100
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="lower1">
                    Lower Volume by 1
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="raise1">
                    Raise Volume by 1
                </button>
            </div>

            <p>
                Valid volume levels are from 1 to 100
            </p>

            <h2>Animator web page name and ip address:</h2>

            <div class="mui-textfield">
                <label>Base url:</label>
                <input type="text" id="settingsWebsiteUrl" placeholder="Enter website name"
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div class="mui-textfield">
                <label>IP Address:</label>
                <input class="input" id="settingsIpAddress" type="text" disabled
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div>
                <button id="websiteSubmitButton" class="mui-btn mui-btn--primary" type="button"
                    data-url="/update-host-name">
                    Change
                </button>
            </div>

            <p>
                Use alphanumerics and dashes only. All names are automatically
                appended with .local. So your website url will be something like
                "website-name.local and the ip address will be xx.xx.xx.xx."
            </p>

            <h2>Utilities:</h2>
            <button class="mui-btn mui-btn--primary animator-action" data-value="speaker_test" data-url="/speaker"
                type="button">
                Speaker Test
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="reset_to_defaults" data-url="/defaults"
                type="button">
                Reset to defaults
            </button>

        </div>
        <div class="mui-tabs__pane" id="tables">
            <h2>Animation scripts:</h2>
            <p>
                Animation scripts run the animation. To load the script press the button for the sound track you want to
                modify.
                Modify the script as needed and press save to save the script.
            </p>
            <h2>Built in sound tracks:</h2>
            <div id="builtInTracksScriptContainer"></div>
            <h2>My sound tracks:</h2>
            <div id="myTracksScriptContainer"></div>
            <h2>Animation script table:</h2>
            <div class="mui-textfield">
                <input class="input" id="animationName" type="text" disabled>
            </div>
            <div>SNXXX = Servo N (0 All, 1-6) XXX 0 to 180</div>
            <div>LNXXX = Lights N (0 All, 1-6) XXX 0 to 255</div>
            <div>BXXX = Brightness XXX 0 to 100</div>
            <div>FXXX = Fade brightness in or out XXX 0 to 100</div>
            <div>ZRTTT = Rainbow, TTT cycle speed in decimal seconds</div>
            <div>
                <button id="saveAnimationScriptDataButton" class="mui-btn mui-btn--primary" type="button">Save
                    Animations</button>
                <button class="mui-btn mui-btn--primary" onclick="editPasteTableDialog(0)">Edit Paste Table</button>
                <button class="mui-btn mui-btn--primary" onclick="pasteRowsAndResetTable()">Paste Table</button>
                <table id="dataTable" class="mui-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>TimeStamp</th>
                            <th>TimeCode</th>
                            <th>Animation</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</body>

<script>
    local_ip = ""

    function showAlert(message) {
        var alertModal = document.createElement('div');
        alertModal.className = 'mui-container';
        alertModal.style.width = '400px';
        alertModal.style.margin = '100px auto'; // Center horizontally with top margin
        alertModal.style.backgroundColor = '#fff';
        alertModal.style.borderRadius = '5px';
        alertModal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';

        alertModal.innerHTML = `
            <div class="mui-form" style="padding: 20px;">
                <legend style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Alert</legend>
                <div style="margin: 10px 0; font-size: 1em; color: #333;">
                    ${message}
                </div>
                <button class="mui-btn mui-btn--primary" onclick="closeAlert()" style="margin-top: 15px;">OK</button>
            </div>`;

        mui.overlay('on', alertModal);
    }


    function closeAlert() {
        mui.overlay('off');
    }

    // ============================================================================
    // Helper: Extract table data in server-friendly format (seconds|animation)
    // Ignores row number column and action column
    // ============================================================================
    function getTableDataAsServerFormat() {
        const rows = Array.from(document.querySelectorAll("#dataTable tbody tr"));
        return rows.map(row => {
            const cells = row.querySelectorAll("td");
            // cells[0] = row number (skip)
            const secondsInput = cells[1]?.querySelector("input")?.value?.trim() || "";
            const animationInput = cells[3]?.querySelector("input")?.value?.trim() || "";

            // Convert displayed timecode back to seconds if needed, but prefer seconds input
            let seconds = secondsInput;
            if (!seconds && cells[2]?.querySelector("input")?.value) {
                seconds = convertTimeCodeToSeconds(cells[2].querySelector("input").value) || "0.0";
            }

            if (seconds === "" && animationInput === "") return null; // skip completely empty rows

            return (parseFloat(seconds) || 0).toFixed(1) + "|" + animationInput;
        }).filter(line => line !== null && line !== "0.0|");
    }

    // ============================================================================
    // Save animation script – sends data in blocks to /save-data
    // ============================================================================
    function saveAnimationScriptData() {
        saveAnimationScriptDataButton.setAttribute("disabled", "true");

        const combinedData = getTableDataAsServerFormat();
        if (combinedData.length === 0) {
            showAlert("No animation data to save.");
            saveAnimationScriptDataButton.removeAttribute("disabled");
            return;
        }

        const blockSize = 5;
        const totalBlocks = Math.ceil(combinedData.length / blockSize);

        function sendBlockSequentially(index) {
            if (index >= totalBlocks) {
                saveAnimationScriptDataButton.removeAttribute("disabled");
                showAlert("Animation saved successfully.");
                return;
            }

            const startIdx = index * blockSize;
            const endIdx = Math.min((index + 1) * blockSize, combinedData.length);
            const block = combinedData.slice(startIdx, endIdx);

            let payload = [index, totalBlocks - 1, block];
            if (index === totalBlocks - 1) {
                payload = [index, totalBlocks - 1, block, animationName.value];
            }

            fetch("/save-data", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Error saving block " + (index + 1));
                    return sendBlockSequentially(index + 1);
                })
                .catch(error => {
                    showAlert("Save failed: " + error.message);
                    saveAnimationScriptDataButton.removeAttribute("disabled");
                });
        }

        sendBlockSequentially(0);
    }

    // ============================================================================
    // Populate the main animation table – now includes row number
    // ============================================================================
    function populateAnimationsTable(data) {
        animationTableBody.innerHTML = "";

        data.forEach(function (rowData, index) {
            const row = createDataRow(rowData, index);
            animationTableBody.appendChild(row);
        });
    }

    // ============================================================================
    // Create a single table row – now with row number as first cell
    // ============================================================================
    function createDataRow(rowData, rowIndex) {
        const row = document.createElement("tr");
        const parts = rowData.split("|");

        // Column 0: Row number (static)
        const rowNumCell = document.createElement("td");
        rowNumCell.textContent = (rowIndex + 1).toString();
        rowNumCell.style.width = "45px";
        rowNumCell.style.textAlign = "center";
        rowNumCell.style.fontWeight = "bold";
        rowNumCell.style.color = "#444";
        rowNumCell.style.backgroundColor = "#f8f9fa";
        row.appendChild(rowNumCell);

        // Column 1: TimeStamp (seconds)
        const seconds = parts[0] ? parts[0].trim() : "";
        const tsCell = createEditableCell(seconds, "85px");
        tsCell.addEventListener('keydown', e => {
            if (e.keyCode === 13) timeSecondsCellChanged(e);
        });
        row.appendChild(tsCell);

        // Column 2: TimeCode (hh:mm:ss:ff)
        let timeCode = "";
        if (seconds) {
            timeCode = convertSecondsToTimeCode(parseFloat(seconds));
        }
        const tcCell = createEditableCell(timeCode, "120px");
        tcCell.addEventListener('keydown', e => {
            if (e.keyCode === 13) timeCodeCellChanged(e);
        });
        row.appendChild(tcCell);

        // Column 3: Animation commands
        const animation = parts[1] ? parts[1].trim() : "";
        const anCell = createEditableCell(animation, "520px");
        anCell.addEventListener('click', animationCellClicked);
        row.appendChild(anCell);

        // Column 4: Action buttons
        const actionCell = document.createElement("td");
        actionCell.style.whiteSpace = "nowrap";
        actionCell.appendChild(createTestButton());
        actionCell.appendChild(createEditButton());
        actionCell.appendChild(createInsertButton());
        actionCell.appendChild(createAddButton());
        actionCell.appendChild(createDeleteButton());
        row.appendChild(actionCell);

        return row;
    }

    // ============================================================================
    // Re-populate table after insert/delete/add – keeps row numbers correct
    // ============================================================================
    function copyAndResetTable() {
        const combinedData = getTableDataAsServerFormat();
        populateAnimationsTable(combinedData);
    }

    // ============================================================================
    // Paste table logic – updated for new column structure
    // ============================================================================
    function pasteRowsAndResetTable() {
        const rows = Array.from(animationTableBody.querySelectorAll("tr"));

        // Extract current table state
        const currentData = rows.map(row => {
            const cells = row.querySelectorAll("td");
            return {
                seconds: cells[1]?.querySelector("input")?.value?.trim() || "",
                animation: cells[3]?.querySelector("input")?.value?.trim() || ""
            };
        });

        // Apply paste starting from globalRowIndex
        let pasteIndex = 0;
        while (globalRowIndex < currentData.length && pasteIndex < globalPasteTable.length) {
            currentData[globalRowIndex].animation = globalPasteTable[pasteIndex];
            globalRowIndex++;
            pasteIndex++;
        }

        // Convert back to combined format
        const combinedData = currentData.map(row => {
            let seconds = row.seconds;
            if (!seconds && row.animation) {
                seconds = "0.0"; // default if animation present but no time
            }
            const secNum = parseFloat(seconds) || 0;
            return secNum.toFixed(1) + "|" + (row.animation || "");
        });

        populateAnimationsTable(combinedData);
    }

    // ============================================================================
    // Row insertion / deletion helpers – they now call copyAndResetTable()
    // which automatically fixes row numbers
    // ============================================================================
    function insertRow(row) {
        const newRow = createDataRow("|", 0); // temporary – numbers will be fixed
        animationTableBody.insertBefore(newRow, row);
        copyAndResetTable();
    }

    function addRow(row) {
        const newRow = createDataRow("|", 0);
        animationTableBody.insertBefore(newRow, row.nextSibling);
        copyAndResetTable();
    }

    function deleteRow(row) {
        row.remove();
        copyAndResetTable();
    }

    function removeChildNodes(myDiv) {
        // Remove all child nodes
        while (myDiv.firstChild) {
            myDiv.removeChild(myDiv.firstChild);
        }
        // Remove all event listeners attached to the div
        const clonedDiv = myDiv.cloneNode(true);
        myDiv.parentNode.replaceChild(clonedDiv, myDiv);
    }

    // Load initial data after webpage loads
    document.addEventListener('DOMContentLoaded', function () {
        getHostName()
        getVolume()
        getLocalIp()
        getBuiltInSoundTracks()
        getCustomersSoundTracks()
    })

    function getHostName() {
        // get website url
        fetch('/get-host-name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function getVolume() {
        fetch('/get-volume', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                volume.value = data; // Set the value of the input field with the received data
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function getLocalIp() {
        fetch('/get-local-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                local_ip = data; // Set the value of the input field with the received data
                data = data.replace(/^"|"$/g, '');
                settingsIpAddress.value = data
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function getBuiltInSoundTracks() {
        fetch('/get-built-in-sound-tracks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                my_data = JSON.parse(data)
                setBuiltInSoundTrackButtons(my_data)
                setBuiltInSoundTrackScriptButtons(my_data)
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function getCustomersSoundTracks() {
        fetch('/get-customers-sound-tracks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                my_data = JSON.parse(data)
                setCustomersSoundTrackButtons(my_data)
                setCustomersSoundTrackScriptButtons(my_data)
            })
            .catch(function (error) {
                console.log(error);
            });
    }

    function setBuiltInSoundTrackButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        // Handle the response from the server
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            button.removeAttribute('disabled');
                        }
                    })
                    .catch(function (error) {
                        button.removeAttribute('disabled');
                        showAlert('Try Again');
                    });
            });
            builtInTracksContainer.appendChild(button);
        });
    }

    function setBuiltInSoundTrackScriptButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/get-animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        return response.text(); // assuming the response is plain text
                    })
                    .then(function (data) {
                        myData = JSON.parse(data); // Set the value of the input field with the received data
                        animationName.value = animation
                        populateAnimationsTable(myData)
                        button.removeAttribute('disabled')
                    })
                    .catch(function (error) {
                        console.log(error);
                        button.removeAttribute('disabled')
                    });
            });
            builtInTracksScriptContainer.appendChild(button);
        });
    }

    function setCustomersSoundTrackButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item.replace("c_", "");
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        // Handle the response from the server
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            button.removeAttribute('disabled');
                        }
                    })
                    .catch(function (error) {
                        button.removeAttribute('disabled');
                        showAlert('Try Again');
                    });
            });
            myTracksContainer.appendChild(button);
        });
    }

    function setCustomersSoundTrackScriptButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item.replace("c_", "");
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/get-animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        return response.text(); // assuming the response is plain text
                    })
                    .then(function (data) {
                        myData = JSON.parse(data); // Set the value of the input field with the received data
                        animationName.value = animation
                        populateAnimationsTable(myData)
                        button.removeAttribute('disabled')
                    })
                    .catch(function (error) {
                        console.log(error);
                        button.removeAttribute('disabled')
                    });
            });
            myTracksScriptContainer.appendChild(button);
        });
    }

    // Get all buttons with the 'animator-action' class
    // Add click event listener to each button
    var actionButtons = document.querySelectorAll('.animator-action');
    actionButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = button.getAttribute('data-url');
            var animation = button.getAttribute('data-value');
            var redirectUrl = button.getAttribute('data-redirect');

            // Create an object with the data to be sent in the request
            var data = {
                an: animation,
            };

            button.setAttribute('disabled', 'true')

            // Make a POST request using fetch
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    // Handle the response from the server
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        button.removeAttribute('disabled');
                    }
                })
                .catch(function (error) {
                    button.removeAttribute('disabled');
                    showAlert('Try Again');
                });
        });
    });

    // Get all buttons with the 'animator-volume-update' class
    // Add click event listener to each button
    var volumeUpdateButtons = document.querySelectorAll('.animator-volume-update');
    volumeUpdateButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = this.getAttribute('data-url');
            var action = this.getAttribute('data-action');
            data = {
                action: action
            }

            button.setAttribute('disabled', 'true')
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text(); // assuming the response is plain text
                })
                .then(function (data) {
                    volume.value = data; // Set the value of the input field with the received data
                    button.removeAttribute('disabled')
                })
                .catch(function (error) {
                    console.log(error);
                    button.removeAttribute('disabled')
                });
        });
    });

    // Add click event listener to website submit button
    var websiteSubmitButton = document.getElementById('websiteSubmitButton');
    websiteSubmitButton.addEventListener('click', function () {
        var settingsWebsiteUrl = document.getElementById('settingsWebsiteUrl');
        var websiteUrlText = settingsWebsiteUrl.value;
        var url = this.getAttribute('data-url');

        var data = {
            an: websiteUrlText,
        };

        websiteSubmitButton.setAttribute('disabled', 'true')

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
                websiteSubmitButton.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                websiteSubmitButton.removeAttribute('disabled')
            });
    });

    // Restrict input to letters, numbers, and hyphens only
    settingsWebsiteUrl.addEventListener('input', function () {
        var validatedValue = this.value.replace(/[^a-zA-Z0-9-]/g, '');
        this.value = validatedValue;
    });

    // Table component
    var saveAnimationScriptDataButton = document.getElementById("saveAnimationScriptDataButton");
    var dataTable = document.getElementById("dataTable");
    var animationTableBody = document.querySelector("#dataTable tbody");

    saveAnimationScriptDataButton.addEventListener("click", function () {
        saveAnimationScriptData();
    });

    animationTableBody.addEventListener("click", function (event) {
        var target = event.target;
        if (target.classList.contains("insert-row-btn")) {
            insertRow(target.parentNode.parentNode);
        } else if (target.classList.contains("delete-row-btn")) {
            deleteRow(target.parentNode.parentNode);
        } else if (target.classList.contains("add-row-btn")) {
            addRow(target.parentNode.parentNode);
        } else if (target.classList.contains("test-row-btn")) {
            const rowElement = target.parentNode.parentNode;
            const commandInput = getTextOfInput(rowElement, 3);
            testAnimation(target, commandInput)
        } else if (target.classList.contains("edit-row-btn")) {
            var clickedRow = event.target.closest('tr'); // This gets the <tr> element directly
            rowIndex = Array.prototype.indexOf.call(clickedRow.parentNode.children, clickedRow);
            const rowElement = target.parentNode.parentNode;
            const commandInput = getTextOfInput(rowElement, 3);
            editPasteTableDialog(1, commandInput, rowIndex)
        }
    });

    function testAnimation(target, commandInput) {
        var url = "/test-animation";
        if (target) target.setAttribute("disabled", "true");

        var data = {
            an: commandInput,
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text();
            })
            .then(function (data) {
                console.log(data);
                if (target) target.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                if (target) target.removeAttribute('disabled')
            });
    }

    function getTextOfInput(rowElement, elNum) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            return inputElements[elNum - 1].value;
        } else {
            return "";
        }
    }

    function setTextOfInput(rowElement, elNum, textVal) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            inputElements[elNum - 1].value = textVal;
        }
    }

    function timeSecondsCellChanged(event) {
        var inputValue = convertSecondsToTimeCode(event.target.value)
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 2, inputValue);
    }

    function timeCodeCellChanged(event) {
        var inputValue = convertTimeCodeToSeconds(event.target.value)
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 1, inputValue);
    }

    // Global variables to store number of rows and data
    var globalPasteTableNumRows = 0;
    var globalPasteTable = [];
    var globalRowIndex = 0; // Index for data

    function animationCellClicked(event) {
        var clickedRow = event.target.closest('tr'); // This gets the <tr> element directly
        globalRowIndex = Array.prototype.indexOf.call(clickedRow.parentNode.children, clickedRow);
        console.log("Row Index:", globalRowIndex);
    }

    function editPasteTableDialog(type, commandsText = "", rowIndex = 0) {
        var modalEl = document.getElementById("modalEl");
        removeChildNodes(modalEl);
        modalEl.style.width = '600px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px';
        form.style.margin = '20px';

        if (type == 1) {
            var legend1 = document.createElement('legend');
            legend1.textContent = 'Commands';
            form.appendChild(legend1);

            // Create sliders container
            var slidersContainer = document.createElement('div');
            slidersContainer.style.marginBottom = '20px';
            slidersContainer.style.padding = '10px';

            // Create sliders for S1-S6 (0-180)
            var sSliderGrid = document.createElement('div');
            sSliderGrid.style.display = 'flex';
            sSliderGrid.style.flexWrap = 'wrap';
            sSliderGrid.style.gap = '5px';
            for (let i = 1; i <= 6; i++) {
                var sliderDiv = document.createElement('div');
                sliderDiv.className = 'mui-textfield';
                sliderDiv.style.width = 'calc(16.66% - 5px)';
                sliderDiv.innerHTML = `
                <label style="display: inline-block; ">S${i}: <span id="S${i}Value">0</span></label>
                <input type="range" id="S${i}" min="0" max="180" value="0" style="width: calc(100% - 5px); vertical-align: middle;">
            `;
                sSliderGrid.appendChild(sliderDiv);
            }
            slidersContainer.appendChild(sSliderGrid);

            // Create sliders for L1-L6 (0-255)
            var lSliderGrid = document.createElement('div');
            lSliderGrid.style.display = 'flex';
            lSliderGrid.style.flexWrap = 'wrap';
            lSliderGrid.style.gap = '5px';
            for (let i = 1; i <= 6; i++) {
                var sliderDiv = document.createElement('div');
                sliderDiv.className = 'mui-textfield';
                sliderDiv.style.width = 'calc(16.66% - 5px)';
                sliderDiv.innerHTML = `
                <label style="display: inline-block; ">L${i}: <span id="L${i}Value">0</span></label>
                <input type="range" id="L${i}" min="0" max="255" value="0" style="width: calc(100% - 5px); vertical-align: middle;">
            `;
                lSliderGrid.appendChild(sliderDiv);
            }
            slidersContainer.appendChild(lSliderGrid);

            var settingsField = document.createElement('div');
            settingsField.className = 'mui-textfield';
            var input = document.createElement('input');
            input.id = "sliderSettings"
            input.type = 'text';
            input.placeholder = 'Enter value';
            input.value = commandsText;
            settingsField.appendChild(input);

            slidersContainer.appendChild(settingsField);

            form.appendChild(slidersContainer);
        }


        if (type == 0) {
            var legend = document.createElement('legend');
            legend.textContent = 'Paste table';
            form.appendChild(legend);

            // Input for number of rows
            var numberRowsInput = document.createElement('div');
            numberRowsInput.className = 'mui-textfield';
            numberRowsInput.innerHTML = '<input type="number" id="numRows" placeholder="Number of rows" min="1" />';
            form.appendChild(numberRowsInput);

            // Button to generate the table
            var generateBtn = document.createElement('button');
            generateBtn.type = 'button';
            generateBtn.className = 'mui-btn mui-btn--primary';
            generateBtn.textContent = 'Generate Table';
            generateBtn.addEventListener('click', generateTable);
            form.appendChild(generateBtn);

            // Container for the table
            var tableContainer = document.createElement('div');
            tableContainer.id = 'tableContainer';
            form.appendChild(tableContainer);
        }

        // Save button
        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', function () {
            if (type == 0) {
                var data = collectTableData();
                globalPasteTable = data;
                globalPasteTableNumRows = data.length;
            }
            if (type == 1) {
                let inputValue = document.getElementById("sliderSettings").value;
                changeCommandCell(rowIndex, 2, inputValue)
            }
            mui.overlay('off', modalEl);
        });
        form.appendChild(saveBtn);

        // Clear button
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'mui-btn mui-btn--secondary';
        clearBtn.textContent = 'Clear';
        clearBtn.addEventListener('click', function () {
            if (type == 0) {
                clearTableData();
            }
            if (type == 1) {
                document.getElementById('sliderSettings').value = '';
                for (let i = 1; i <= 6; i++) {
                    document.getElementById(`S${i}`).value = 0;
                    document.getElementById(`S${i}Value`).textContent = '0';
                    document.getElementById(`L${i}`).value = 0;
                    document.getElementById(`L${i}Value`).textContent = '0';
                }
            }
        });
        form.appendChild(clearBtn);

        // Cancel button
        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);

        // Add event listeners for sliders
        function updateSliderSettings(sliderId, value) {
            var settingsField = document.getElementById('sliderSettings');
            var currentValue = settingsField.value;
            var prefix = sliderId.startsWith('S') ? 'S' : 'L';
            var setting = `${prefix}${sliderId.slice(1)}${value}`;

            testAnimation(null, setting);

            // Create regex for matching the specific slider setting (e.g., S1\d+ or L1\d+)
            var regex = new RegExp(`${prefix}${sliderId.slice(1)}\\d+`);

            if (regex.test(currentValue)) {
                // Replace existing setting if it exists
                settingsField.value = currentValue.replace(regex, setting);
            } else {
                // Append new setting, removing any existing duplicate setting with same prefix and number
                settingsField.value = currentValue
                    ? `${currentValue.replace(new RegExp(`${prefix}${sliderId.slice(1)}\\d+,?`), '')}${currentValue ? ',' : ''}${setting}`
                    : setting;
            }
        }

        if (type == 1) {
            for (let i = 1; i <= 6; i++) {
                // S1-S6 sliders
                let sSlider = document.getElementById(`S${i}`);
                let sValue = document.getElementById(`S${i}Value`);
                if (sSlider && sValue) {
                    sSlider.addEventListener('input', function () {
                        sValue.textContent = this.value;
                    });
                    sSlider.addEventListener('mouseup', function () {
                        updateSliderSettings(`S${i}`, this.value);
                    });
                }

                // L1-L6 sliders
                let lSlider = document.getElementById(`L${i}`);
                let lValue = document.getElementById(`L${i}Value`);
                if (lSlider && lValue) {
                    lSlider.addEventListener('input', function () {
                        lValue.textContent = this.value;
                    });
                    lSlider.addEventListener('mouseup', function () {
                        updateSliderSettings(`L${i}`, this.value);
                    });
                }
            }

        }

        // Populate fields if there's existing data
        if (type == 0) {
            document.getElementById('numRows').value = globalPasteTableNumRows;
            if (globalPasteTableNumRows > 0) {
                generateTable(globalPasteTable);
            }
        }

        // Function to generate the table
        function generateTable(data) {
            var numRows = parseInt(document.getElementById('numRows').value, 10) || globalPasteTableNumRows;
            var tableContainer = document.getElementById('tableContainer');
            removePasteTableChildNodes(tableContainer);

            if (numRows > 0) {
                var table = document.createElement('table');
                table.className = 'mui-table';
                for (var i = 0; i < numRows; i++) {
                    var row = table.insertRow();
                    var myCell = row.insertCell(0);
                    myCell.style.padding = '0';
                    var textFieldDiv = document.createElement('div');
                    textFieldDiv.className = 'mui-textfield';
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Enter value';
                    input.value = data[i] || '';
                    textFieldDiv.appendChild(input);
                    myCell.appendChild(textFieldDiv);

                    var buttonCell = row.insertCell(1);
                    buttonCell.style.padding = '0';
                    buttonCell.style.textAlign = 'center';
                    var testButton = createTestButton();
                    buttonCell.appendChild(testButton);
                    testButton.addEventListener('click', function (event) {
                        var target = event.target;
                        var commandInput = this.parentNode.parentNode.cells[0].querySelector('input').value;
                        testAnimation(target, commandInput);
                    });
                }
                tableContainer.appendChild(table);
            } else {
                showAlert("Please enter a valid number of rows.");
            }
        }

        // Function to collect data from the table
        function collectTableData() {
            var table = document.querySelector('#tableContainer table');
            var data = [];
            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    var rowData = table.rows[i].cells[0].querySelector('input').value;
                    data.push(rowData);
                }
            }
            return data;
        }

        // Function to clear input values from the table
        function clearTableData() {
            var table = document.querySelector('#tableContainer table');
            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    table.rows[i].cells[0].querySelector('input').value = '';
                }
            }
        }
    }

    function changeCommandCell(rowY, colX, newValue) {
        const tbody = document.getElementById("dataTable").querySelector("tbody");
        const input = tbody.rows[rowY].cells[colX].querySelector("div.mui-textfield input");
        input.value = newValue;
    }

    // Helper function to remove all child nodes from an element
    function removePasteTableChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    function createEditableCell(value, widthVal) {
        var cell = document.createElement("td");
        var input = document.createElement("input");
        input.type = "text";
        input.className = "pure-input-rounded";
        input.value = value;
        input.style.width = widthVal
        input.style.whiteSpace = "pre-wrap";
        input.style.overflow = "visible";
        var div = document.createElement("div");
        div.className = "mui-textfield";
        div.appendChild(input);
        cell.appendChild(div);
        return cell;
    }

    function createTestButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary test-row-btn";
        button.innerHTML = 'T';
        return button;
    }

    function createDeleteButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary delete-row-btn";
        button.innerHTML = 'D';
        return button;
    }

    function createInsertButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary insert-row-btn";
        button.innerHTML = 'I';
        return button;
    }

    function createAddButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary add-row-btn";
        button.innerHTML = 'A';
        return button;
    }

    function createEditButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary edit-row-btn";
        button.innerHTML = 'E';
        return button;
    }

    // Function to convert DaVinci Resolve timestamp to seconds
    function convertTimeCodeToSeconds(timestamp) {
        var parts = timestamp.split(':');
        var hours = parseInt(parts[0]);
        var minutes = parseInt(parts[1]);
        var seconds = parseInt(parts[2]);
        var frames = parseInt(parts[3]);

        hours -= 1

        var totalSeconds = hours * 3600 + minutes * 60 + seconds + frames / 24;

        if (!totalSeconds) totalSeconds = 0;

        return totalSeconds.toFixed(1);
    }

    // Function to convert seconds to DaVinci Resolve timestamp
    function convertSecondsToTimeCode(seconds) {
        var hours = Math.floor(seconds / 3600) + 1;
        seconds %= 3600;
        var minutes = Math.floor(seconds / 60);
        seconds %= 60;
        var frames = Math.round((seconds - Math.floor(seconds)) * 24);

        if (!seconds) {
            hours = 1
            minutes = 0
            frames = 0
        }

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(Math.floor(seconds)).padStart(2, '0')}:${String(frames).padStart(2, '0')}`;
    }

</script>

</html>