<!DOCTYPE html>
<html>

<head>
    <title>Animator - Ride on train</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/mui.min.css" />
    <script src="/mui.min.js"></script>
    <style>
        .parent-container {
            display: grid;
            place-items: center;
            width: max-content;
            height: max-content;
            position: relative;
            margin: auto;
        }

        .knob-container {
            display: grid;
            place-items: center;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .knob {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #c6d6f7 30%, #4a7aeb);
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            user-select: none;
            transform: rotate(0deg);
        }

        .indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgb(12, 88, 228);
            border-radius: 50%;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .knob-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="modalEl"></div>
    <div class="mui-container">
        <h1>Animator - Ride on train</h1>
        <p style="padding-top:0.5rem;">
            Use this web app to control and setup your Animator - Ride on train
            product. Have fun animating.
        </p>
        <button id="leftButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="left"
            data-url="/mode">Left</button>
        <button id="rightButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="right"
            data-url="/mode">Right</button>
        <button id="rightButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="right_held"
            data-url="/mode">Right Held</button>
        <ul class="mui-tabs__bar">
            <li class="mui--is-active">
                <a data-mui-toggle="tab" data-mui-controls="trainControl">Train Control</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="animations">Animations</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="settings">Settings</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="tables">Animation tables</a>
            </li>
        </ul>
        <div class="mui-tabs__pane mui--is-active" id="trainControl" style="padding-top:0.5rem;">
            <div class="parent-container ">
                <div class="knob-container">
                    <div class="knob" id="knob">
                        <div class="indicator"></div>
                    </div>
                    <div class="knob-text" id="knob-text">0</div>
                </div>
            </div>
            <button class="mui-btn mui-btn--primary" onclick="stopTrain()">Stop</button>
            <button class="mui-btn mui-btn--primary" onclick="blowHorn()">Horn</button>
            <button class="mui-btn mui-btn--primary" onclick="ringBell()">Bell</button>
            <button class="mui-btn mui-btn--primary" onclick="home()">Home</button>
            <button class="mui-btn mui-btn--primary" onclick="openGates()">Open Gates</button>
            <button class="mui-btn mui-btn--primary" onclick="closeGates()">Close Gates</button>
        </div>
        <div class="mui-tabs__pane" id="animations" style="padding-top:0.5rem;">
            <button class="mui-btn mui-btn--primary animator-action" data-value="random all" data-url="/animation"
                type="button">
                Random all animations
            </button>
            <h2>Animations:</h2>
            <div id="animationsContainer"></div>
            <h2>Animation settings:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_on" data-url="/mode"
                    type="button">
                    Continuous Mode On
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_off" data-url="/mode"
                    type="button">
                    Continuous Mode Off
                </button>
            </div>
        </div>
        <div class="mui-tabs__pane" id="settings">
            <h2>Platform positions:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S00" data-url="/lights"
                    type="button">
                    All 0
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S090" data-url="/lights"
                    type="button">
                    All 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S0180" data-url="/lights"
                    type="button">
                    All 180
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S190" data-url="/lights"
                    type="button">
                    Servo 1 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S290" data-url="/lights"
                    type="button">
                    Servo 2 90
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="S390" data-url="/lights"
                    type="button">
                    Servo 3 90
                </button>
            </div>
            <h2>Test lights:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_255_0_0" data-url="/lights"
                    type="button">
                    Red
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_0_255_0" data-url="/lights"
                    type="button">
                    Green
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_0_0_255" data-url="/lights"
                    type="button">
                    Blue
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_255_255_255" data-url="/lights"
                    type="button">
                    White
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B0" data-url="/lights"
                    type="button">
                    Off
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B20" data-url="/lights"
                    type="button">
                    20
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B40" data-url="/lights"
                    type="button">
                    40
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B60" data-url="/lights"
                    type="button">
                    60
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B80" data-url="/lights"
                    type="button">
                    80
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="B100" data-url="/lights"
                    type="button">
                    100
                </button>
            </div>
            <h2>Volume:</h2>
            <button class="mui-btn mui-btn--primary animator-action" data-value="volume_pot_on" data-url="/speaker"
                type="button">
                Volume Pot On
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="volume_pot_off" data-url="/speaker"
                type="button">
                Volume Pot Off
            </button>
            <div class="mui-textfield">
                <input class="input" id="volume" type="number" disabled>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume10">
                    Volume 10
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume20">
                    Volume 20
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume30">
                    Volume 30
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume40">
                    Volume 40
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume50">
                    Volume 50
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume60">
                    Volume 60
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume70">
                    Volume 70
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume80">
                    Volume 80
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume90">
                    Volume 90
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume100">
                    Volume 100
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="lower1">
                    Lower Volume by 1
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="raise1">
                    Raise Volume by 1
                </button>
            </div>

            <p>
                Valid volume levels are from 1 to 100
            </p>

            <h2>Animator web page name and ip address:</h2>

            <div class="mui-textfield">
                <label>Base url:</label>
                <input type="text" id="settingsWebsiteUrl" placeholder="Enter website name"
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div class="mui-textfield">
                <label>IP Address:</label>
                <input class="input" id="settingsIpAddress" type="text" disabled
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div>
                <button id="websiteSubmitButton" class="mui-btn mui-btn--primary" type="button"
                    data-url="/update-host-name">
                    Change
                </button>
            </div>

            <p>
                Use alphanumerics and dashes only. All names are automatically
                appended with .local. So your website url will be something like
                "website-name.local and the ip address will be xx.xx.xx.xx."
            </p>

            <h2>Utilities:</h2>
            <button class="mui-btn mui-btn--primary animator-action" data-value="speaker_test" data-url="/speaker"
                type="button">
                Speaker Test
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="reset_to_defaults" data-url="/defaults"
                type="button">
                Reset to defaults
            </button>

        </div>
        <div class="mui-tabs__pane" id="tables">
            <h2>Animation scripts:</h2>
            <p>Follow these steps to setup animations:</p>
            <ol>
                <li><strong>Create:</strong> Click the create button to add a new animator.</li>
                <li><strong>Duplicate, Rename, or Delete:</strong> Select the animator you want to edit, then use the
                    corresponding buttons to duplicate, rename, or delete it.</li>
            </ol>
            <button class="mui-btn mui-btn--primary" onclick="createAnimationDialog()">Create
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="duplicateAnimationDialog()">Duplicate
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="renameAnimationDialog()">Rename
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="deleteAnimationDialog()">Delete
                Animation</button>
            <h2>Animations:</h2>
            <div id="animationScriptsContainer"></div>
            <h2>Animation table:</h2>
            <div class="mui-textfield">
                <input class="input" id="animationScriptName" type="text" disabled>
            </div>
            <div>SNXXX = Servo N (0 All, 1-6) XXX 0 to 180</div>
            <div>LNZZZ_R_G_B = Neopixels ZZZ (0 All, 1 to 999) RGB 0 to 255</div>
            <div>LNR_SSS_EEE_R_G_B = Neo pixel lights SSS start (1 to 999), EEE end (1 to 999), RGB 0 to 255</div>
            <div>BXXX = Brightness XXX 0 to 100</div>
            <div>FXXX = Fade brightness in or out XXX 0 to 100</div>
            <div>TXXX = Train XXX throttle -100 to 100</div>
            <div>H_XXX_YY = Home train XXX throttle -100 to 100 YY position 12 or 6 o'clock</div>
            <div>MALXXX = Play file, A (P play music, W play music wait, S stop music), L = file location (S sound
                tracks, M mvc folder) XXX (file name)</div>
            <div>HORN = Blow horn</div>
            <div>BELL = Ring bell</div>
            <div>CLOSE close gate</div>
            <div>OPEN open gate</div>
            <div>ZRAND = Random rainbow, fire, or color change</div>
            <div>ZRTTT = Rainbow, TTT cycle speed in decimal seconds</div>
            <div>ZFIRE = Fire</div>
            <div>ZCOLCH = Color change</div>
            <div>H_XXX_GGG_TTT = Home train XXX throttle -100 to 100, GGG decimal position, TTT decimal tolerance</div>
            <div>WXXX = Wait XXX decimal seconds</div> 
            <div>
                <button id="saveAnimationScriptDataButton" class="mui-btn mui-btn--primary" type="button">Save
                    Animations</button>
                <button class="mui-btn mui-btn--primary" onclick="editPasteTableDialog()">Edit Paste Table</button>
                <button class="mui-btn mui-btn--primary" onclick="pasteRowsAndResetTable()">Paste Table</button>
                <table id="dataTable" class="mui-table">
                    <thead>
                        <tr>
                            <th>TimeStamp</th>
                            <th>TimeCode</th>
                            <th>Animation</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</body>

<script>
    local_ip = ""

    function removeChildNodes(myDiv) {
        // Remove all child nodes
        while (myDiv.firstChild) {
            myDiv.removeChild(myDiv.firstChild);
        }
        // Remove all event listeners attached to the div
        const clonedDiv = myDiv.cloneNode(true);
        myDiv.parentNode.replaceChild(clonedDiv, myDiv);
    }


    function showAlert(message) {
        var alertModal = document.createElement('div');
        alertModal.className = 'mui-container';
        alertModal.style.width = '400px';
        alertModal.style.margin = '100px auto'; // Center horizontally with top margin
        alertModal.style.backgroundColor = '#fff';
        alertModal.style.borderRadius = '5px';
        alertModal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';

        alertModal.innerHTML = `
            <div class="mui-form" style="padding: 20px;">
                <legend style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Alert</legend>
                <div style="margin: 10px 0; font-size: 1em; color: #333;">
                    ${message}
                </div>
                <button class="mui-btn mui-btn--primary" onclick="closeAlert()" style="margin-top: 15px;">OK</button>
            </div>`;

        mui.overlay('on', alertModal);
    }


    function closeAlert() {
        mui.overlay('off');
    }

    // Load initial data after webpage loads
    document.addEventListener('DOMContentLoaded', function () {
        // get website url
        fetch('/get-host-name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
            })
            .catch(function (error) {
                console.log(error);
            });

        // get volume
        fetch('/get-volume', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                volume.value = data; // Set the value of the input field with the received data
            })
            .catch(function (error) {
                console.log(error);
            });

        // get local ip
        fetch('/get-local-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                local_ip = data; // Set the value of the input field with the received data
                settingsIpAddress.value = local_ip
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });

        getAnimations()
    });

    function getAnimations() {
        // get Animations
        fetch('/get-animations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                my_data = JSON.parse(data)
                setRunAnimationButtons(my_data)
                setGetAnimationButtons(my_data)
            })
            .catch(function (error) {
                console.log(error);
            });
    }


    function createAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Create Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', createAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }


    function createAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            console.log('Filename:', filenameInput);
            var data = {
                fn: filenameInput,
            };

            fetch("/create-animation", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (data) {
                    updateAnimations()
                    var modalEl = document.getElementById("modalEl")
                    mui.overlay('off', modalEl)
                })
                .catch(function (error) {
                    console.log(error);
                    showAlert(error);
                });
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }

    function duplicateAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Duplicate Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', duplicateAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }


    function duplicateAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            animationScriptName.value = filenameInput;
            saveAnimationScriptData();
            updateAnimations()
            var modalEl = document.getElementById("modalEl")
            mui.overlay('off', modalEl)
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }


    function renameAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Rename Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', renameAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }

    function renameAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            console.log('Filename:', filenameInput);
            var data = {
                fo: animationScriptName.value,
                fn: filenameInput,
            };

            fetch("/rename-animation", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (data) {
                    updateAnimations()
                    var modalEl = document.getElementById("modalEl")
                    mui.overlay('off', modalEl)
                })
                .catch(function (error) {
                    console.log(error);
                    showAlert(error);
                });
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }

    function deleteAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Delete Animation';
        form.appendChild(legend);

        var message = document.createElement('div');
        message.className = "mui-textfield"
        message.textContent = "Are you sure your want to delete " + animationScriptName.value + " this is irreversible.";
        form.appendChild(message);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Delete';
        saveBtn.addEventListener('click', deleteAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }

    function deleteAnimation() {
        var data = {
            fn: animationScriptName.value,
        };

        fetch("/delete-animation", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                updateAnimations()
                console.log("file deleted")
                var modalEl = document.getElementById("modalEl")
                mui.overlay('off', modalEl)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }


    function updateAnimations() {
        const myAnimationScriptsDiv = document.getElementById("animationScriptsContainer");
        removeChildNodes(myAnimationScriptsDiv)
        const myAnimationsDiv = document.getElementById("animationsContainer");
        removeChildNodes(myAnimationsDiv)
        getAnimations()
    }

    function setRunAnimationButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        // Handle the response from the server
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            button.removeAttribute('disabled');
                        }
                    })
                    .catch(function (error) {
                        button.removeAttribute('disabled');
                        alert('Try Again');
                    });
            });
            animationsContainer.appendChild(button);
        });
    }

    function setGetAnimationButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/get-animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        return response.text(); // assuming the response is plain text
                    })
                    .then(function (data) {
                        myData = JSON.parse(data); // Set the value of the input field with the received data
                        animationScriptName.value = animation
                        populateAnimationsTable(myData)
                        button.removeAttribute('disabled')
                    })
                    .catch(function (error) {
                        console.log(error);
                        button.removeAttribute('disabled')
                    });
            });
            animationScriptsContainer.appendChild(button);
        });
    }

    // Get all buttons with the 'animator-action' class
    // Add click event listener to each button
    var actionButtons = document.querySelectorAll('.animator-action');
    actionButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = button.getAttribute('data-url');
            var animation = button.getAttribute('data-value');
            var redirectUrl = button.getAttribute('data-redirect');

            // Create an object with the data to be sent in the request
            var data = {
                an: animation,
            };

            button.setAttribute('disabled', 'true')

            // Make a POST request using fetch
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    // Handle the response from the server
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        button.removeAttribute('disabled');
                    }
                })
                .catch(function (error) {
                    button.removeAttribute('disabled');
                    alert('Try Again');
                });
        });
    });

    // Get all buttons with the 'animator-volume-update' class
    // Add click event listener to each button
    var volumeUpdateButtons = document.querySelectorAll('.animator-volume-update');
    volumeUpdateButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = this.getAttribute('data-url');
            var action = this.getAttribute('data-action');
            data = {
                action: action
            }

            button.setAttribute('disabled', 'true')
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text(); // assuming the response is plain text
                })
                .then(function (data) {
                    volume.value = data; // Set the value of the input field with the received data
                    button.removeAttribute('disabled')
                })
                .catch(function (error) {
                    console.log(error);
                    button.removeAttribute('disabled')
                });
        });
    });

    // Add click event listener to website submit button
    var websiteSubmitButton = document.getElementById('websiteSubmitButton');
    websiteSubmitButton.addEventListener('click', function () {
        var settingsWebsiteUrl = document.getElementById('settingsWebsiteUrl');
        var websiteUrlText = settingsWebsiteUrl.value;
        var url = this.getAttribute('data-url');

        var data = {
            an: websiteUrlText,
        };

        websiteSubmitButton.setAttribute('disabled', 'true')

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
                websiteSubmitButton.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                websiteSubmitButton.removeAttribute('disabled')
            });
    });

    // Restrict input to letters, numbers, and hyphens only
    settingsWebsiteUrl.addEventListener('input', function () {
        var validatedValue = this.value.replace(/[^a-zA-Z0-9-]/g, '');
        this.value = validatedValue;
    });

    // Table component
    var saveAnimationScriptDataButton = document.getElementById("saveAnimationScriptDataButton");
    var dataTable = document.getElementById("dataTable");
    var animationTableBody = document.querySelector("#dataTable tbody");

    saveAnimationScriptDataButton.addEventListener("click", function () {
        saveAnimationScriptData();
    });

    function populateAnimationsTable(data) {
        // Clear existing table rows
        animationTableBody.innerHTML = "";

        // Populate table with new data
        data.forEach(function (rowData) {
            var row = createDataRow(rowData);
            animationTableBody.appendChild(row);
        });
    }

    animationTableBody.addEventListener("click", function (event) {
        var target = event.target;
        if (target.classList.contains("insert-row-btn")) {
            insertRow(target.parentNode.parentNode);
        } else if (target.classList.contains("delete-row-btn")) {
            deleteRow(target.parentNode.parentNode);
        } else if (target.classList.contains("add-row-btn")) {
            addRow(target.parentNode.parentNode);
        } else if (target.classList.contains("test-row-btn")) {
            testAnimation(target)
        }
    });

    function testAnimation(target) {
        const rowElement = target.parentNode.parentNode;
        const thirdInput = getTextOfInput(rowElement, 3);
        target.setAttribute("disabled", "true");
        var url = "/test-animation";

        var data = {
            an: thirdInput,
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text();
            })
            .then(function (data) {
                console.log(data);
                target.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                target.removeAttribute('disabled')
            });
    }

    async function testAnimationCommand(command) {
        if (!command) {
            console.log("Invalid command, stopping request: " + command);
            return;
        }

        const url = "/test-animation";
        const data = { an: command };
        const jsonData = JSON.stringify({ ...data });

        try {
            let response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: jsonData,
            });

            let text = await response.text();
            return text;
        } catch (error) {
            console.log("Fetch Error: " + error + "Sending Data: " + jsonData);
        }
    }



    function getTextOfInput(rowElement, elNum) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            return inputElements[elNum - 1].value;
        } else {
            return "";
        }
    }

    function setTextOfInput(rowElement, elNum, textVal) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            inputElements[elNum - 1].value = textVal;
        }
    }

    function timeSecondsCellChanged(event) {
        var inputValue = convertSecondsToTimeCode(event.target.value)
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 2, inputValue);
    }

    function timeCodeCellChanged(event) {
        var inputValue = convertTimeCodeToSeconds(event.target.value)
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 1, inputValue);
    }

    // Global variables to store number of rows and data
    var globalPasteTableNumRows = 0;
    var globalPasteTable = [];
    var globalRowIndex = 0; // Index for data

    function pasteRowsAndResetTable() {
        var pasteIndex = 0;

        var rows = Array.from(animationTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null;
                return cellValue;
            });
            return values;
        });

        console.log(globalPasteTable);
        console.log(data);

        // First mutate the data
        while (globalRowIndex < data.length && pasteIndex < globalPasteTable.length) {
            // Replace data[globalRowIndex][2] with the item from globalPasteTable
            data[globalRowIndex][2] = globalPasteTable[pasteIndex];
            globalRowIndex++; // Move to the next row in data
            pasteIndex++; // Move to the next item in globalPasteTable
        }

        // Now combine the data into combinedData
        const combinedData = data.map(function (row) {
            var secondsConverted = convertTimeCodeToSeconds(row[1]);
            return secondsConverted + "|" + (row[2] || ""); // Ensure a fallback in case row[2] is undefined
        });

        console.log(combinedData);

        // Populate the table with the combined data
        populateAnimationsTable(combinedData);
    }



    function animationCellClicked(event) {
        var clickedRow = event.target.closest('tr'); // This gets the <tr> element directly
        globalRowIndex = Array.prototype.indexOf.call(clickedRow.parentNode.children, clickedRow);
        console.log("Row Index:", globalRowIndex);
    }

    function editPasteTableDialog() {
        var modalEl = document.getElementById("modalEl");
        removeChildNodes(modalEl);
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px';
        form.style.margin = '20px';

        var legend = document.createElement('legend');
        legend.textContent = 'Paste table';
        form.appendChild(legend);

        // Input for number of rows
        var numberRowsInput = document.createElement('div');
        numberRowsInput.className = 'mui-textfield';
        numberRowsInput.innerHTML = '<input type="number" id="numRows" placeholder="Number of rows" min="1" />';
        form.appendChild(numberRowsInput);

        // Button to generate the table
        var generateBtn = document.createElement('button');
        generateBtn.type = 'button';
        generateBtn.className = 'mui-btn mui-btn--primary';
        generateBtn.textContent = 'Generate Table';
        generateBtn.addEventListener('click', generateTable);
        form.appendChild(generateBtn);

        // Container for the table
        var tableContainer = document.createElement('div');
        tableContainer.id = 'tableContainer';
        form.appendChild(tableContainer);

        // Save button
        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', function () {
            var data = collectTableData();
            globalPasteTable = data; // Save data globally
            globalPasteTableNumRows = data.length; // Save the number of rows globally
            mui.overlay('off', modalEl); // Close modal after saving
        });
        form.appendChild(saveBtn);

        // Clear button
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'mui-btn mui-btn--secondary';
        clearBtn.textContent = 'Clear';
        clearBtn.addEventListener('click', function () {
            clearTableData(); // Clear input values but keep the table structure
        });
        form.appendChild(clearBtn);

        // Cancel button
        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);

        // Populate fields if there's existing data
        document.getElementById('numRows').value = globalPasteTableNumRows;
        if (globalPasteTableNumRows > 0) {
            generateTable(globalPasteTable); // Generate the table with existing data
        }

        // Function to generate the table
        function generateTable(data) {
            var numRows = parseInt(document.getElementById('numRows').value, 10) || globalPasteTableNumRows;
            var tableContainer = document.getElementById('tableContainer');
            removePasteTableChildNodes(tableContainer); // Clear existing table if any

            if (numRows > 0) {
                var table = document.createElement('table');
                table.className = 'mui-table';
                // Create rows
                for (var i = 0; i < numRows; i++) {
                    var row = table.insertRow();
                    var myCell = row.insertCell(0);
                    myCell.style.padding = '0';
                    var textFieldDiv = document.createElement('div');
                    textFieldDiv.className = 'mui-textfield';
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Enter value';
                    input.value = data[i] || ''; // Populate with existing data if available
                    textFieldDiv.appendChild(input);
                    myCell.appendChild(textFieldDiv);
                }

                tableContainer.appendChild(table);
            } else {
                showAlert("Please enter a valid number of rows.");
            }
        }

        // Function to collect data from the table
        function collectTableData() {
            var table = document.querySelector('#tableContainer table');
            var data = [];

            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    var rowData = table.rows[i].cells[0].querySelector('input').value;
                    data.push(rowData);
                }
            }

            return data;
        }

        // Function to clear input values from the table
        function clearTableData() {
            var table = document.querySelector('#tableContainer table');
            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    table.rows[i].cells[0].querySelector('input').value = '';
                }
            }
        }
    }

    // Helper function to remove all child nodes from an element
    function removePasteTableChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }


    function createDataRow(rowData) {
        var row = document.createElement("tr");
        myRowDataSplit = rowData.split("|")

        if (myRowDataSplit[0]) {
            var tsCell = createEditableCell(myRowDataSplit[0], "80px");
            tsCell.addEventListener('keydown', function (event) {
                if (event.keyCode === 13) {
                    timeSecondsCellChanged(event);
                }
            });
        } else {
            var tsCell = createEditableCell("", "80px");
        }
        row.appendChild(tsCell);

        if (myRowDataSplit[0]) {
            var timeCode = convertSecondsToTimeCode(myRowDataSplit[0])
            var tcCell = createEditableCell(timeCode, "110px");
            tcCell.addEventListener('keydown', function (event) {
                if (event.keyCode === 13) {
                    timeCodeCellChanged(event);
                }
            });

        } else {
            var tcCell = createEditableCell("", "110px");
        }
        row.appendChild(tcCell);

        if (myRowDataSplit[1]) {
            var anCell = createEditableCell(myRowDataSplit[1], "500px");
            anCell.addEventListener('click', function (event) {
                animationCellClicked(event);
            });
        } else {
            var anCell = createEditableCell("", "500px");
            anCell.addEventListener('click', function (event) {
                animationCellClicked(event);
            });
        }
        row.appendChild(anCell);

        var actionCell = document.createElement("td");

        var testButton = createTestButton();
        actionCell.appendChild(testButton);

        var insertButton = createInsertButton();
        actionCell.appendChild(insertButton);

        var addButton = createAddButton();
        actionCell.appendChild(addButton);

        var deleteButton = createDeleteButton();
        actionCell.appendChild(deleteButton);

        row.appendChild(actionCell);

        return row;
    }

    function createEditableCell(value, widthVal) {
        var cell = document.createElement("td");
        var input = document.createElement("input");
        input.type = "text";
        input.className = "pure-input-rounded";
        input.value = value;
        input.style.width = widthVal
        input.style.whiteSpace = "pre-wrap";
        input.style.overflow = "visible";
        var div = document.createElement("div");
        div.className = "mui-textfield";
        div.appendChild(input);
        cell.appendChild(div);
        return cell;
    }

    function createTestButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary test-row-btn";
        button.innerHTML = 'Tst';
        return button;
    }

    function createDeleteButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary delete-row-btn";
        button.innerHTML = 'Del';
        return button;
    }

    function createInsertButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary insert-row-btn";
        button.innerHTML = 'Ins';
        return button;
    }

    function createAddButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary add-row-btn";
        button.innerHTML = 'Add';
        return button;
    }

    function deleteRow(row) {
        row.parentNode.removeChild(row);
        copyAndResetTable();
    }

    function addRow(row) {
        var newRow = createDataRow("|");
        animationTableBody.insertBefore(newRow, row.nextSibling);
        copyAndResetTable();
    }

    function insertRow(row) {
        var newRow = createDataRow("|");
        animationTableBody.insertBefore(newRow, row);
        copyAndResetTable();
    }

    function copyAndResetTable() {
        var rows = Array.from(animationTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null
                return cellValue;
            });
            return values;
        });

        combinedData = []

        for (let i = 0; i < data.length; i++) {
            var secondsConverted = convertTimeCodeToSeconds(data[i][1])
            combinedData.push(secondsConverted + "|" + data[i][2])
        }

        populateAnimationsTable(combinedData)
    }

    function saveAnimationScriptData() {
        saveAnimationScriptDataButton.setAttribute("disabled", "true");
        var rows = Array.from(animationTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null
                return cellValue;
            });
            return values;
        });

        combinedData = []

        for (let i = 0; i < data.length; i++) {
            var secondsConverted = convertTimeCodeToSeconds(data[i][1])
            combinedData.push(secondsConverted + "|" + data[i][2])
        }

        const blockSize = 5;
        const totalBlocks = Math.ceil(combinedData.length / blockSize);

        // Function to send each block sequentially
        function sendBlockSequentially(index) {
            if (index >= totalBlocks) {
                // All blocks have been sent, enable the button
                saveAnimationScriptDataButton.removeAttribute('disabled');
                return;
            }

            const startIdx = index * blockSize;
            const endIdx = Math.min((index + 1) * blockSize, combinedData.length);
            const block = combinedData.slice(startIdx, endIdx);
            let myObject = [index, totalBlocks - 1, block]
            if (index == totalBlocks - 1) {
                myObject = [index, totalBlocks - 1, block, animationScriptName.value]
            }

            // Send data to the server
            fetch("/save-data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(myObject)
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Error saving data. Please try again.");
                    }
                    // Send the next block sequentially
                    sendBlockSequentially(index + 1);
                })
                .catch(function (error) {
                    alert(error.message);
                    // Enable the button even if an error occurs
                    saveAnimationScriptDataButton.removeAttribute('disabled');
                });
        }

        // Start sending blocks sequentially
        sendBlockSequentially(0);
    }

    // Function to convert DaVinci Resolve timestamp to seconds
    function convertTimeCodeToSeconds(timestamp) {
        var parts = timestamp.split(':');
        var hours = parseInt(parts[0]);
        var minutes = parseInt(parts[1]);
        var seconds = parseInt(parts[2]);
        var frames = parseInt(parts[3]);

        hours -= 1

        var totalSeconds = hours * 3600 + minutes * 60 + seconds + frames / 24;

        if (!totalSeconds) totalSeconds = 0;

        return totalSeconds.toFixed(1);
    }

    // Function to convert seconds to DaVinci Resolve timestamp
    function convertSecondsToTimeCode(seconds) {
        var hours = Math.floor(seconds / 3600) + 1;
        seconds %= 3600;
        var minutes = Math.floor(seconds / 60);
        seconds %= 60;
        var frames = Math.round((seconds - Math.floor(seconds)) * 24);

        if (!seconds) {
            hours = 1
            minutes = 0
            frames = 0
        }

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(Math.floor(seconds)).padStart(2, '0')}:${String(frames).padStart(2, '0')}`;
    }


    const knob = document.getElementById('knob');
    const knobText = document.getElementById('knob-text');
    let isDragging = false;
    let previousAngle = 0;
    let currentRotation = 0;
    let lastSentTime = 0;
    let throttleTimeout = null; // Prevents multiple stacked timeouts
    const throttleTime = 500

    function stopTrain() {
        previousAngle = 0;
        currentRotation = 0;
        const displayValue = Math.round((currentRotation / 180) * 100);
        knob.style.transform = `rotate(${currentRotation}deg)`;
        knobText.innerText = displayValue;

        let newCommand = "T" + displayValue;

        // Throttle command sending
        throttleSendCommand(newCommand);
    }

    function blowHorn() {
        let newCommand = "HORN";
        testAnimationCommand(newCommand);
    }

    function ringBell() {
        let newCommand = "BELL";
        testAnimationCommand(newCommand);
    }

    function home() {
        let newCommand = "H_20_5_3";
        testAnimationCommand(newCommand);
    }

    function openGates() {
        let newCommand = "OPEN";
        testAnimationCommand(newCommand);
    }

    function closeGates() {
        let newCommand = "CLOSE";
        testAnimationCommand(newCommand);
    }

    function getAngle(x, y, centerX, centerY) {
        return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
    }

    function onStart(event) {
        isDragging = true;
        const rect = knob.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        previousAngle = getAngle(clientX, clientY, centerX, centerY);
    }

    function onMove(event) {
        if (!isDragging) return;

        const rect = knob.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;

        const currentAngle = getAngle(clientX, clientY, centerX, centerY);
        let angleDiff = currentAngle - previousAngle;

        if (angleDiff > 180) angleDiff -= 360;
        if (angleDiff < -180) angleDiff += 360;

        currentRotation += angleDiff;
        currentRotation = Math.max(-180, Math.min(180, currentRotation));

        const displayValue = Math.round((currentRotation / 180) * 100);
        knob.style.transform = `rotate(${currentRotation}deg)`;
        knobText.innerText = displayValue;

        let newCommand = "T" + displayValue;

        // Throttle command sending
        throttleSendCommand(newCommand);

        previousAngle = currentAngle;
    }

    function throttleSendCommand(command) {
        if (throttleTimeout) {
            clearTimeout(throttleTimeout); // Cancel any existing timeout
        }

        const now = Date.now();
        if (now - lastSentTime >= throttleTime) {
            sendThrottledCommand(command);
        } else {
            throttleTimeout = setTimeout(() => sendThrottledCommand(command), throttleTime);
        }
    }

    async function sendThrottledCommand(command) {
        if (!command) return; // Ignore invalid commands

        lastSentTime = Date.now();
        throttleTimeout = null; // Clear timeout reference

        try {
            await testAnimationCommand(command);
        } catch (error) {
            console.error("Error sending animation command:", error);
        }
    }

    function onEnd() {
        isDragging = false;
    }

    knob.addEventListener('mousedown', onStart);
    knob.addEventListener('touchstart', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove);
    window.addEventListener('mouseup', onEnd);
    window.addEventListener('touchend', onEnd);

    // Prevent iPhone screen from moving when dragging the knob
    knob.addEventListener('touchstart', event => event.preventDefault(), { passive: false });
    knob.addEventListener('touchmove', event => event.preventDefault(), { passive: false });

</script>

</html>
