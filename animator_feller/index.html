<!DOCTYPE html>
<html>

<head>
  <title>Animator - Feller</title>
  <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/mui.min.css" />
  <script src="/mui.min.js"></script>
  <style>
    input[type=file]::file-selector-button {
      font-weight: 500;
      font-size: 14px;
      line-height: 18px;
      text-transform: uppercase;
      color: #FFF;
      background-color: #2196F3;
      -webkit-transition: all .2s ease-in-out;
      transition: all .2s ease-in-out;
      display: inline-block;
      height: 36px;
      padding: 0 26px;
      margin: 6px 6px 6px 0px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      -ms-touch-action: manipulation;
      touch-action: manipulation;
      background-image: none;
      text-align: center;
      line-height: 36px;
      vertical-align: middle;
      white-space: nowrap;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      font-size: 14px;
      font-family: inherit;
      letter-spacing: .03em;
      position: relative;
      overflow: hidden;
    }

    input[type=file]::file-selector-button:hover {
      background: #39a1f4;
    }
  </style>
</head>

<body>
  <div class="mui-container">
    <h1>Animator - Feller</h1>
    <p style="padding-top:0.5rem;">
      Use this web app to control and calibrate your animator - feller
      product. Have fun animating.
    </p>
    <ul class="mui-tabs__bar">
      <li class="mui--is-active">
        <a data-mui-toggle="tab" data-mui-controls="animations">Animations</a>
      </li>
      <li>
        <a data-mui-toggle="tab" data-mui-controls="adjustments">Adjustments</a>
      </li>
      <li>
        <a data-mui-toggle="tab" data-mui-controls="settings">Settings</a>
      </li>
    </ul>
    <div class="mui-tabs__pane mui--is-active" id="animations" style="padding-top:0.5rem;">
      <button class="mui-btn mui-btn--primary animator-feller" data-value="random" data-url="/animation" type="button">
        Random
      </button>
      <button class="mui-btn mui-btn--primary animator-feller disabled" data-value="forth_of_july" data-url="/animation"
        type="button">
        Forth of July
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="christmas" data-url="/animation"
        type="button">
        Christmas
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="halloween" data-url="/animation"
        type="button">
        Halloween
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="birds_dogs" data-url="/animation"
        type="button">
        Birds and Dogs
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="birds_dogs_short_version"
        data-url="/animation" type="button">
        Birds and Dogs Short
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="just_birds" data-url="/animation"
        type="button">
        Just Birds
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="machines" data-url="/animation"
        type="button">
        Machine
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="owl" data-url="/animation" type="button">
        Owls
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="no_sounds" data-url="/animation"
        type="button">
        No other sounds
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="train" data-url="/animation" type="button">
        Train
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="alien" data-url="/animation" type="button">
        Alien
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="happy_birthday" data-url="/animation"
        type="button">
        Happy Birthday
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="cont_mode_on" data-url="/animation"
        type="button">
        Continuous Mode On
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="cont_mode_off" data-url="/animation"
        type="button">
        Continuous Mode Off
      </button>
    </div>
    <div class="mui-tabs__pane" id="adjustments" style="padding-top:0.5rem;">
      <p">Use the buttons below to adjust the feller and tree. Press the position you want to calibrate
        and then adjust. When finished press Save.</p>

        <h2>Feller - Positions and adjustments</h2>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_rest_pos" data-url="/feller"
            type="button">Rest</button>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_chop_pos" data-url="/feller"
            type="button">Chop</button>
        </div>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_clockwise" data-url="/feller"
            type="button">Clockwise</button>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_counter_clockwise"
            data-url="/feller" type="button">Counter Clockwise</button>
        </div>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_cal_saved" data-url="/feller"
            type="button">Save Feller Adjustment</button>
        </div>

        <h2>Tree - Positions and adjustments</h2>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="tree_up_pos" data-url="/tree"
            type="button">Upright</button>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="tree_down_pos" data-url="/tree"
            type="button">Fallen</button>
        </div>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="tree_up" data-url="/tree"
            type="button">Up</button>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="tree_down" data-url="/tree"
            type="button">Down</button>
        </div>
        <div>
          <button class="mui-btn mui-btn--primary animator-feller" data-value="tree_cal_saved" data-url="/tree"
            type="button">Save Tree Adjustment</button>
        </div>
    </div>
    <div class="mui-tabs__pane" id="settings">
      <h2>Dialog options:</h2>
      <div>
        <button class="mui-btn mui-btn--primary animator-feller" data-value="opening_dialog_on" data-url="/dialog"
          type="button">
          Opening dialog on
        </button>
        <button class="mui-btn mui-btn--primary animator-feller" data-value="opening_dialog_off" data-url="/dialog"
          type="button">
          Opening dialog off
        </button>
      </div>
      <div>
        <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_advice_on" data-url="/dialog"
          type="button">
          Feller advice on
        </button>
        <button class="mui-btn mui-btn--primary animator-feller" data-value="feller_advice_off" data-url="/dialog"
          type="button">
          Feller advice off
        </button>
      </div>
      <h2>Animator web page name:</h2>

      <div class="mui-textfield">
        <input class="input" animator-feller" id="textInput" type="text" placeholder="Enter website name">
        <button id="submitButton" class="mui-btn mui-btn--primary" type="button" data-url="/update-host-name">
          Change
        </button>
      </div>

      <p>
        Use alphanumerics and dashes only. All names are automatically
        appended with .local. So your website url will be something like
        "website-name.local"
      </p>

      <h2>Utilities:</h2>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="speaker_test" data-url="/utilities"
        type="button">
        Speaker Test
      </button>
      <button class="mui-btn mui-btn--primary animator-feller" data-value="reset_to_defaults" data-url="/utilities"
        type="button">
        Reset to defaults
      </button>

        <div id="betaDev">
              <h2>File Upload:</h2>
              <form id="fileUploadForm">
                <input type="file" id="fileInput">
                <div>
                  <button type="submit" class="mui-btn mui-btn--primary">Upload</button>
                  <progress id="uploadProgress" value="0" max="100" style="display: none;"></progress>
                  <div id="statusMessage" style="display: none;"></div>
                </div>
              </form>

              <h2>Editable Table:</h2>

              <button id="fetchDataButton" class="mui-btn mui-btn--primary" type="button">Fetch Data</button>
              <button id="saveDataButton" class="mui-btn mui-btn--primary" type="button">Save Data</button>
              <button id="goBackButton" class="mui-btn mui-btn--primary" type="button">Goto Home</button>

              <table id="dataTable" class="mui-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
        </div>

    </div>
  </div>
</body>

<script>
  var submitButton = document.getElementById('submitButton');

  // Get all buttons with the 'animator-feller' class
  var buttons = document.querySelectorAll('.animator-feller');

  submitButton.addEventListener('click', function () {
    var textInput = document.getElementById('textInput');
    var textValue = textInput.value;
    var url = this.getAttribute('data-url');

    var data = {
      text: textValue,
    };

    submitButton.setAttribute('disabled', 'true')

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    })
      .then(function (response) {
        return response.text(); // assuming the response is plain text
      })
      .then(function (data) {
        textInput.value = data; // Set the value of the input field with the received data
        submitButton.removeAttribute('disabled')
      })
      .catch(function (error) {
        console.log(error);
        submitButton.removeAttribute('disabled')
      });
  });

  // Load initial data
  document.addEventListener('DOMContentLoaded', function () {
    fetch('/get-host-name', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(function (response) {
        return response.text(); // assuming the response is plain text
      })
      .then(function (data) {
        textInput.value = data; // Set the value of the input field with the received data
      })
      .catch(function (error) {
        console.log(error);
      });
  });

  // Restrict input to letters, numbers, and hyphens only
  textInput.addEventListener('input', function () {
    var validatedValue = this.value.replace(/[^a-zA-Z0-9-]/g, '');
    this.value = validatedValue;
  });

  // Add click event listener to each button
  buttons.forEach(function (button) {
    button.addEventListener('click', function () {
      var animation = this.getAttribute('data-value');
      var url = this.getAttribute('data-url');
      var redirectUrl = this.getAttribute('data-redirect');
      if (!redirectUrl) button.setAttribute('disabled', 'true');

      // Create an object with the data to be sent in the request
      var data = {
        animation: animation,
      };

      // Make a POST request using fetch
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      })
        .then(function (response) {
          // Handle the response from the server
          if (redirectUrl) {
            window.location.href = redirectUrl;
          } else {
            button.removeAttribute('disabled');
          }
        })
        .catch(function (error) {
          button.removeAttribute('disabled');
          alert('Try Again');
        });
    });
  });
</script>
<script>
  document.getElementById("betaDev").style.visibility = "hidden";
  var fetchDataButton = document.getElementById("fetchDataButton");
  var saveDataButton = document.getElementById("saveDataButton");
  var dataTable = document.getElementById("dataTable");
  var dataTableBody = document.querySelector("#dataTable tbody");
  const fileUploadForm = document.getElementById('fileUploadForm');
  const progressContainer = document.querySelector('.mui-progress');
  const uploadProgress = document.getElementById('uploadProgress');
  const statusMessage = document.getElementById('statusMessage');
  const fileInput = document.getElementById('fileInput');

  fetchDataButton.addEventListener("click", function () {
    fetchData();
  });

  saveDataButton.addEventListener("click", function () {
    saveData();
  });

  goBackButton.addEventListener("click", function () {
    window.location.href = "http://animator-feller.local";
  });

  dataTableBody.addEventListener("click", function (event) {
    var target = event.target;
    if (target.classList.contains("insert-row-btn")) {
      insertRow(target.parentNode.parentNode);
    } else if (target.classList.contains("add-row-btn")) {
      addRow(target.parentNode.parentNode);
    } else if (target.classList.contains("delete-row-btn")) {
      deleteRow(target.parentNode.parentNode);
    }
  });

  function fetchData() {
    // Simulate API call delay
    fetchDataButton.setAttribute("disabled", "true");
    setTimeout(function () {
      var fakeData = [
        { id: 1, name: "John Doe", email: "john@example.com" },
        { id: 2, name: "Jane Smith", email: "jane@example.com" },
        { id: 3, name: "Robert Johnson", email: "robert@example.com" }
      ];
      populateTable(fakeData);
    }, 1000); // Simulated delay of 1 second
  }

  function populateTable(data) {
    // Clear existing table rows
    dataTableBody.innerHTML = "";

    // Populate table with new data
    data.forEach(function (rowData) {
      var row = createDataRow(rowData);
      dataTableBody.appendChild(row);
    });
    fetchDataButton.removeAttribute("disabled");
  }

  function createDataRow(rowData) {
    var row = document.createElement("tr");

    var idCell = createEditableCell(rowData.id);
    row.appendChild(idCell);

    var nameCell = createEditableCell(rowData.name);
    row.appendChild(nameCell);

    var emailCell = createEditableCell(rowData.email);
    row.appendChild(emailCell);

    var actionCell = document.createElement("td");

    var insertButton = createInsertButton();
    actionCell.appendChild(insertButton);

    var addButton = createAddButton();
    actionCell.appendChild(addButton);

    var deleteButton = createDeleteButton();
    actionCell.appendChild(deleteButton);

    row.appendChild(actionCell);

    return row;
  }

  function createEditableCell(value) {
    var cell = document.createElement("td");
    var input = document.createElement("input");
    input.type = "text";
    input.className = "pure-input-rounded";
    input.value = value;
    var div = document.createElement("div");
    div.className = "mui-textfield";
    div.appendChild(input);
    cell.appendChild(div);
    return cell;
  }

  function createDeleteButton() {
    var button = document.createElement("button");
    button.type = "button";
    button.className = "mui-btn mui-btn--primary delete-row-btn";
    button.innerHTML = 'Delete';
    return button;
  }

  function createInsertButton() {
    var button = document.createElement("button");
    button.type = "button";
    button.className = "mui-btn mui-btn--primary insert-row-btn";
    button.innerHTML = 'Insert';
    return button;
  }

  function createAddButton() {
    var button = document.createElement("button");
    button.type = "button";
    button.className = "mui-btn mui-btn--primary add-row-btn";
    button.innerHTML = 'Add';
    return button;
  }

  function deleteRow(row) {
    row.parentNode.removeChild(row);
  }

  function insertRow(row) {
    var newRow = createDataRow({ id: "", name: "", email: "" });
    dataTableBody.insertBefore(newRow, row.nextSibling);
  }

  function addRow(row) {
    var newRow = createDataRow({ id: "", name: "", email: "" });
    dataTableBody.insertBefore(newRow, row.nextSibling);
  }

  function saveData() {
    var rows = Array.from(dataTableBody.querySelectorAll("tr"));

    // Extract data from table rows
    var data = rows.map(function (row) {
      var cells = Array.from(row.querySelectorAll("td"));
      var values = cells.map(function (cell) {
        const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null
        return cellValue;
      });
      return values;
    });

    console.log(data)

    // Send data to the server
    fetch("/save-data", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
      .then(function (response) {
        if (response.ok) {
          alert("Data saved successfully!");
        } else {
          alert("Error saving data. Please try again.");
        }
      })
      .catch(function (error) {
        alert("An error occurred. Please try again later.");
      });
  }

  fileUploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput.files[0];
    if (!file) {
      alert('Please select a file.');
      return;
    }

    // Record the start time
    const startTime = Date.now();

    // Show the progress bar
    uploadProgress.style.display = 'block';
    statusMessage.style.display = 'none';

    const chunkSize = 1024; // 1 KB chunks

    let offset = 0;

    try {
      while (offset < file.size) {
        const chunk = file.slice(offset, offset + chunkSize);
        const formData = new FormData();
        formData.append('fileChunk', chunk);

        // Send the chunked file data to the server using Fetch API
        const response = await fetch('/upload-endpoint', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          console.error('File upload failed.');
          return;
        }

        offset += chunkSize;
        // Update the progress bar based on the upload progress
        const progress = (offset / file.size) * 100;
        uploadProgress.value = progress;
      }

      // Calculate the duration
      const endTime = Date.now();
      const durationInSeconds = (endTime - startTime) / 1000;
      // Hide the progress bar and show success message
      uploadProgress.style.display = 'none';
      statusMessage.style.display = 'block';
      statusMessage.textContent = `Upload success! Duration: ${durationInSeconds} seconds.`;
      uploadProgress.value = 0;
    } catch (error) {
      // Hide the progress bar and show error message
      uploadProgress.style.display = 'none';
      statusMessage.style.display = 'block';
      statusMessage.textContent = 'Upload failed: ' + error.message;
      uploadProgress.value = 0;
    }
  });

</script>

</html>
