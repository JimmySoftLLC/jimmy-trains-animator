<!DOCTYPE html>
<html>

<head>
    <title>Animator - Camera train</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/mui.min.css" />
    <script src="/mui.min.js"></script>
    <style>
        #progressContainer {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
        }

        #progressBar {
            width: 0;
            height: 30px;
            background-color: #4caf50;
            text-align: center;
            line-height: 30px;
            color: white;
        }

        .color-picker {
            width: 100%;
            height: 100px;
            background-color: #ffffff;
            border: 3px solid #000;
            display: inline-block;
        }

        .bottom-gap {
            height: 100px;
        }

        .parent-container {
            display: flex;
            justify-content: flex-start;
            /* Changed from center to flex-start to align left */
            gap: 20px;
            /* Keeps space between knobs */
            width: max-content;
            height: max-content;
            position: relative;
            margin: 0;
            /* Changed from auto to 0 to remove centering */
        }

        .knob-container {
            display: grid;
            place-items: center;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .knob {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #c6d6f7 30%, #4a7aeb);
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            user-select: none;
            transform: rotate(0deg);
        }

        .indicator {
            position: absolute;
            width: 25px;
            height: 25px;
            background: rgb(12, 88, 228);
            border-radius: 50%;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .knob-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            pointer-events: none;
            text-align: center;
        }

        #videoContainer {
            margin: 20px;
        }

        #controls {
            margin: 20px;
        }

        #playerContainer {
            margin: 20px;
        }

        #thumbnailGallery {
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .thumbnail {
            cursor: pointer;
            border: 2px solid #ccc;
            padding: 5px;
            width: 150px;
            height: 100px;
            object-fit: cover;
        }

        .thumbnail:hover {
            border-color: #333;
        }

        .thumbnail.active {
            border-color: #007bff;
        }

        button {
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        video {
            max-width: 100%;
            height: auto;
        }

        .stream-container {
            position: relative;
            text-align: center;
        }

        .stream-status {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
            font-family: Arial, sans-serif;
        }

        .stream-status.error {
            color: #d9534f;
            /* A soft red color for errors */
            font-weight: bold;
        }

        .mui-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .mui-slider {
            width: 200px;
            /* Adjust as needed */
            accent-color: #2196f3;
            /* Matches mui-btn--primary blue */
        }

        .mui-zoom-value {
            font-family: 'Roboto', sans-serif;
            /* Matches MUI typography */
            color: #2196f3;
        }
    </style>
</head>

<body>
    <div id="modalEl"></div>
    <div class="mui-container">
        <h1>Animator - Camera train</h1>
        <p style="padding-top:0.5rem;">
            Use this web app to control and setup your Animator - Camera train
            product. Have fun animating.
        </p>
        <button id="leftButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="left"
            data-url="/mode">Left</button>
        <button id="rightButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="right"
            data-url="/mode">Right</button>
        <button id="threeButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="three"
            data-url="/mode">Three</button>
        <button id="fourButton" class="mui-btn mui-btn--primary animator-action" type="button" data-value="four"
            data-url="/mode">Four</button>
        <ul class="mui-tabs__bar">
            <li class="mui--is-active">
                <a data-mui-toggle="tab" data-mui-controls="camera">Camera</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="animations">Animations</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="lighting">lights</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="settings">Settings</a>
            </li>
            <li>
                <a data-mui-toggle="tab" data-mui-controls="tables">Animation tables</a>
            </li>
        </ul>
        <div class="mui-tabs__pane mui--is-active" id="camera" style="padding-top:0.5rem;">
            <h2>Video feed:</h2>
            <div class="stream-container">
                <img id="stream" src="/stream.mjpg" alt="MJPEG Stream">
                <div id="streamStatus" class="stream-status"></div>
            </div>
            <div class="mui-tabs__pane mui--is-active" id="tiltControl" style="padding-top:0.5rem;">
                <div class="parent-container">
                    <div class="knob-container">
                        <div class="knob" id="knob">
                            <div class="indicator"></div>
                        </div>
                        <div class="knob-text" id="knob-text">0</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" id="knob2">
                            <div class="indicator"></div>
                        </div>
                        <div class="knob-text" id="knob2-text">0</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" id="knob3">
                            <div class="indicator"></div>
                        </div>
                        <div class="knob-text" id="knob3-text">0</div>
                    </div>
                </div>
            </div>
            <div class="mui-form-group mui-slider-container">
                <label class="mui-form__label" for="zoomSlider">Zoom Level (1x - 6x) beyond 3x resolution
                    decreases:</label>
                <input type="range" id="zoomSlider" class="mui-slider" min="1" max="6" step="0.1" value="1">
                <span id="zoomValue" class="mui-zoom-value">1.0x</span>
            </div>
            <div class="mui-form-group mui-slider-container">
                <label class="mui-form__label" for="focusSlider">Focus (0-10):</label>
                <input type="range" id="focusSlider" class="mui-slider" min="0" max="10" step="0.1" value="1">
                <span id="focusValue" class="mui-zoom-value">1.0</span>
            </div>
            <div id="controls">
                <button id="startBtn" class="mui-btn mui-btn--primary">Start Recording</button>
                <button id="stopBtn" class="mui-btn mui-btn--primary" disabled>Stop Recording</button>
                <button id="downloadBtn" class="mui-btn mui-btn--primary" disabled>Download Current Recording</button>
            </div>
            <div id="controls">
                <button class="mui-btn mui-btn--primary" onclick="startCamera()" type="button">
                    Start stream
                </button>
                <button class="mui-btn mui-btn--primary" onclick="stopCamera()" type="button">
                    Stop stream
                </button>
                <button class="mui-btn mui-btn--primary" onclick="snapshot()" type="button">
                    Snapshot
                </button>
            </div>
            <div id="playerContainer">
                <h3>Selected Video</h3>
                <video id="videoPlayer" controls></video>
            </div>
            <div id="thumbnailGallery">
                <h3>Recordings</h3>
            </div>
            <h2>Light bar:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_255_0_0" data-url="/lights"
                    type="button">
                    Red
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_0_255_0" data-url="/lights"
                    type="button">
                    Green
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_0_0_255" data-url="/lights"
                    type="button">
                    Blue
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="LN0_255_255_255" data-url="/lights"
                    type="button">
                    White
                </button>
            </div>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN0" data-url="/lights"
                    type="button">
                    Off
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN20" data-url="/lights"
                    type="button">
                    20
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN40" data-url="/lights"
                    type="button">
                    40
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN60" data-url="/lights"
                    type="button">
                    60
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN80" data-url="/lights"
                    type="button">
                    80
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="BN100" data-url="/lights"
                    type="button">
                    100
                </button>
            </div>
        </div>
        <div class="mui-tabs__pane" id="animations" style="padding-top:0.5rem;">
            <button class="mui-btn mui-btn--primary animator-action" data-value="random all" data-url="/animation"
                type="button">
                Random all animations
            </button>
            <h2>Animations:</h2>
            <div id="animationsContainer"></div>
            <h2>Animation settings:</h2>
            <div>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_on" data-url="/mode"
                    type="button">
                    Continuous Mode On
                </button>
                <button class="mui-btn mui-btn--primary animator-action" data-value="cont_mode_off" data-url="/mode"
                    type="button">
                    Continuous Mode Off
                </button>
            </div>
        </div>
        <div class="mui-tabs__pane" id="lighting" style="padding-top:0.5rem;">
            <div class="mui-checkbox">
                <label>
                    <input type="checkbox" id="lifxCheckbox" data-url="/set-lifx-enabled">
                    Enable Lifx lights
                </label>
            </div>
            <div id="lifxDiv">
                <h2>Test lifx lights:</h2>
                <div>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LX0_255_0_0" data-url="/lights"
                        type="button">
                        Red
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LX0_0_255_0" data-url="/lights"
                        type="button">
                        Green
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LX0_0_0_255" data-url="/lights"
                        type="button">
                        Blue
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LX0_255_255_255"
                        data-url="/lights" type="button">
                        White
                    </button>
                </div>
                <div>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP0_OFF" data-url="/lights"
                        type="button">
                        All Off
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP0_ON" data-url="/lights"
                        type="button">
                        All On
                    </button>
                </div>
                <div>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP1_ON" data-url="/lights"
                        type="button">
                        1 On
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP2_ON" data-url="/lights"
                        type="button">
                        2 On
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP3_ON" data-url="/lights"
                        type="button">
                        3 On
                    </button>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="LP4_ON" data-url="/lights"
                        type="button">
                        4 On
                    </button>
                </div>
                <h2>Scene colors:</h2>
                <div id="sceneButtonContainer"></div>
                <div>
                    <button class="mui-btn mui-btn--primary animator-action" data-value="reset_scene_to_defaults"
                        data-url="/defaults" type="button">
                        Reset scene colors to defaults
                    </button>
                </div>
                <input class="color-picker" type="color" id="colorPickerLifx" name="colorPickerLifx">
            </div>
            <div class="bottom-gap"></div>
        </div>
        <div class="mui-tabs__pane" id="settings">
            <div class="mui-textfield">
                <input class="input" id="volume" type="number" disabled>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume10">
                    Volume 10
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume20">
                    Volume 20
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume30">
                    Volume 30
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume40">
                    Volume 40
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume50">
                    Volume 50
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume60">
                    Volume 60
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume70">
                    Volume 70
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume80">
                    Volume 80
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume90">
                    Volume 90
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="volume100">
                    Volume 100
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="lower1">
                    Lower Volume by 1
                </button>
                <button class="mui-btn mui-btn--primary animator-volume-update" type="button" data-url="/update-volume"
                    data-action="raise1">
                    Raise Volume by 1
                </button>
            </div>

            <p>
                Valid volume levels are from 1 to 100
            </p>

            <h2>Animator web page name and ip address:</h2>

            <div class="mui-textfield">
                <label>Base url:</label>
                <input type="text" id="settingsWebsiteUrl" placeholder="Enter website name"
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div class="mui-textfield">
                <label>IP Address:</label>
                <input class="input" id="settingsIpAddress" type="text" disabled
                    style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div>
                <button id="websiteSubmitButton" class="mui-btn mui-btn--primary" type="button"
                    data-url="/update-host-name">
                    Change
                </button>
            </div>

            <p>
                Use alphanumerics and dashes only. All names are automatically
                appended with .local:8083. So your website url will be something like
                "website-name.local:8083 and the ip address will be xx.xx.xx.xx:8083."
            </p>

            <h2>Utilities:</h2>
            <button class="mui-btn mui-btn--primary animator-action" data-value="speaker_test" data-url="/speaker"
                type="button">
                Speaker Test
            </button>
            <button class="mui-btn mui-btn--primary animator-action" data-value="reset_to_defaults" data-url="/defaults"
                type="button">
                Reset to defaults
            </button>
        </div>
        <div class="mui-tabs__pane" id="tables">
            <h2>Animation scripts:</h2>
            <p>Follow these steps to setup animations:</p>
            <ol>
                <li><strong>Create:</strong> Click the create button to add a new animator.</li>
                <li><strong>Duplicate, Rename, or Delete:</strong> Select the animator you want to edit, then use the
                    corresponding buttons to duplicate, rename, or delete it.</li>
            </ol>
            <button class="mui-btn mui-btn--primary" onclick="createAnimationDialog()">Create
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="duplicateAnimationDialog()">Duplicate
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="renameAnimationDialog()">Rename
                Animation</button>
            <button class="mui-btn mui-btn--primary" onclick="deleteAnimationDialog()">Delete
                Animation</button>
            <h2>Animations:</h2>
            <div id="animationScriptsContainer"></div>
            <h2>Animation table:</h2>
            <div class="mui-textfield">
                <input class="input" id="animationScriptName" type="text" disabled>
            </div>
            <div>LNZZZ_R_G_B = Neopixel lights/Neo 6 modules ZZZ (0 All, 1 to 999) RGB 0 to 255</div>
            <div>LXZZZ_R_G_B = Lifx lights ZZZ (0 All, 1 to 999) RGB 0 to 255</div>
            <div>LPZZZ_YYY = Lifx lights power ZZZ (0 All, 1 to 999) YYY ON or OFF</div>
            <div>NMZZZ_I_XXX = Neo 6 modules only ZZZ (0 All, 1 to 999) I index (0 All, 1 to 6) XXX 0 to 255
            </div>
            <div>BNYYY = Brightness (Neopixel lights/Neo 6 modules) YYY 000 to 100</div>
            <div>BXYYY = Brightness (Lifx lights) YYY 000 to 100</div>
            <div>FXXX_TTT = Fade brightness (Neopixel lights/Neo 6 modules) in or out XXX 0 to 100, TTT time
                between
                transitions in decimal seconds
            </div>
            <div>ZRAND = Random rainbow, fire, or color change</div>
            <div>ZRTTT = Rainbow, TTT cycle speed in decimal seconds</div>
            <div>ZFIRE = Fire</div>
            <div>ZCOLCH = Color change</div>
            <div>ZJ = Joke</div>
            <div id="neoInstructionsContainer"></div>
            <div id="sceneInstructionsContainer"></div>
            <div>IXXX/XXX = Set desktop image XXX/XXXX(folder/filename)</div>
            <div>SNXXX = Servo N (0 All, 1-6) XXX 0 to 180</div>
            <div>QXXX/XXX = Add media to queue XXX/XXX ("folder/filename" or use "random_folder")</div>
            <div>API_UUU_EEE_DDD = Api POST call UUU base url, EEE endpoint, DDD data object i.e. {"an":
                data_object}</div>
            <!-- <div>C_NN,..._TTT = Cycle, NN one or many commands separated by slashes, TTT interval in decimal seconds
                    between
                    commands</div> -->
            <div>E = End script</div>div>
            <button id="saveDataButton" class="mui-btn mui-btn--primary" type="button">Save
                Animations</button>
            <button id="stopButton" class="mui-btn mui-btn--primary" type="button">Stop</button>
            <button class="mui-btn mui-btn--primary" onclick="editPasteTableDialog()">Edit Paste
                Table</button>
            <button class="mui-btn mui-btn--primary" onclick="pasteRowsAndResetTable()">Paste Table</button>
            <table id="dataTable" class="mui-table">
                <thead>
                    <tr>
                        <th>TimeStamp</th>
                        <th>TimeCode</th>
                        <th>Animation</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    </div>
</body>

<script>
    let programmaticChange = false;
    let isRequestInProgress = false;
    var lifxCheckbox = document.getElementById("lifxCheckbox");
    const streamStatus = document.getElementById('streamStatus');

    // Load initial data after webpage loads
    document.addEventListener('DOMContentLoaded', function () {
        getWebSiteUrl()
        getVolume()
        getSceneChanges()
        getLifxEnabled()
        getLocalIp()
        getAnimations()
    });

    function getAnimations() {
        // get Animations
        fetch('/get-animations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                my_data = JSON.parse(data)
                setRunAnimationButtons(my_data)
                setGetAnimationButtons(my_data)
            })
            .catch(function (error) {
                console.log(error);
            });
    }




    function createAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Create Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', createAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }


    function createAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            console.log('Filename:', filenameInput);
            var data = {
                fn: filenameInput,
            };

            fetch("/create-animation", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (data) {
                    updateAnimations()
                    var modalEl = document.getElementById("modalEl")
                    mui.overlay('off', modalEl)
                })
                .catch(function (error) {
                    console.log(error);
                    showAlert(error);
                });
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }

    function duplicateAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Duplicate Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', duplicateAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }


    function duplicateAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            animationScriptName.value = filenameInput;
            saveAnimationScriptData();
            updateAnimations()
            var modalEl = document.getElementById("modalEl")
            mui.overlay('off', modalEl)
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }


    function renameAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Rename Animation';
        form.appendChild(legend);

        var filenameInput = document.createElement('div');
        filenameInput.className = 'mui-textfield';
        filenameInput.innerHTML = '<input type="text" id="filename" placeholder="Enter filename"/>';
        form.appendChild(filenameInput);

        // Error message container
        var errorMessage = document.createElement('div');
        errorMessage.className = 'mui--text-danger mui--text-caption';
        form.appendChild(errorMessage);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', renameAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }

    function renameAnimation() {
        var filenameInput = document.getElementById('filename').value.trim();
        var errorMessage = document.querySelector('.mui--text-danger');

        if (filenameInput) {
            console.log('Filename:', filenameInput);
            var data = {
                fo: animationScriptName.value,
                fn: filenameInput,
            };

            fetch("/rename-animation", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (data) {
                    updateAnimations()
                    var modalEl = document.getElementById("modalEl")
                    mui.overlay('off', modalEl)
                })
                .catch(function (error) {
                    console.log(error);
                    showAlert(error);
                });
        } else {
            errorMessage.textContent = 'Please enter a filename.';
        }
    }

    function deleteAnimationDialog() {
        var modalEl = document.getElementById("modalEl")
        removeChildNodes(modalEl)
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px'; // Add padding to the form
        form.style.margin = '20px'; // Add margin to the form

        var legend = document.createElement('legend');
        legend.textContent = 'Delete Animation';
        form.appendChild(legend);

        var message = document.createElement('div');
        message.className = "mui-textfield"
        message.textContent = "Are you sure your want to delete " + animationScriptName.value + " this is irreversible.";
        form.appendChild(message);

        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Delete';
        saveBtn.addEventListener('click', deleteAnimation);
        form.appendChild(saveBtn);

        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);
    }

    function deleteAnimation() {
        var data = {
            fn: animationScriptName.value,
        };

        fetch("/delete-animation", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                updateAnimations()
                console.log("file deleted")
                var modalEl = document.getElementById("modalEl")
                mui.overlay('off', modalEl)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }


    function updateAnimations() {
        const myAnimationScriptsDiv = document.getElementById("animationScriptsContainer");
        removeChildNodes(myAnimationScriptsDiv)
        const myAnimationsDiv = document.getElementById("animationsContainer");
        removeChildNodes(myAnimationsDiv)
        getAnimations()
    }

    function setRunAnimationButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        // Handle the response from the server
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            button.removeAttribute('disabled');
                        }
                    })
                    .catch(function (error) {
                        button.removeAttribute('disabled');
                        alert('Try Again');
                    });
            });
            animationsContainer.appendChild(button);
        });
    }

    function setGetAnimationButtons(my_data) {
        // Loop through the data and create a button for each item
        my_data.forEach((item) => {
            const button = document.createElement("button");
            button.textContent = item;
            button.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            button.setAttribute("data-value", item);
            button.setAttribute("data-url", "/get-animation");
            button.setAttribute("type", "button");
            button.addEventListener('click', function () {
                var url = button.getAttribute('data-url');
                var animation = button.getAttribute('data-value');
                var redirectUrl = button.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                button.setAttribute('disabled', 'true')

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(function (response) {
                        return response.text(); // assuming the response is plain text
                    })
                    .then(function (data) {
                        myData = JSON.parse(data); // Set the value of the input field with the received data
                        animationScriptName.value = animation
                        populateAnimationsTable(myData)
                        button.removeAttribute('disabled')
                    })
                    .catch(function (error) {
                        console.log(error);
                        button.removeAttribute('disabled')
                    });
            });
            animationScriptsContainer.appendChild(button);
        });
    }



    function getSceneChanges() {
        fetch('/get-scene-changes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                my_data = JSON.parse(data)
                setSceneChangeButtons(my_data)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function getWebSiteUrl() {
        fetch('/get-host-name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
                makeSocketConnection(data)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }


    local_ip = ""

    function getLocalIp() {
        fetch('/get-local-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                local_ip = data; // Set the value of the input field with the received data
                data = data.replace(/^"|"$/g, '');
                settingsIpAddress.value = data
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function startCamera() {
        fetch('/start-camera', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                streamStatus.textContent = ""
                const stream = document.getElementById('stream');
                setTimeout(() => {
                    stream.src = 'http://animator-camera-train.local:8083/stream.mjpg';
                }, 1000); // Delay to allow server to start camera
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function stopCamera() {
        const stream = document.getElementById('stream');
        stream.src = ''; // Clear the src before stopping the camera

        // Ensure the src is cleared before proceeding
        setTimeout(() => {
            fetch('/stop-camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(function (response) {
                    return response.text(); // assuming the response is plain text
                })
                .then(function (data) {
                    console.log('Camera stopped:', data);
                })
                .catch(function (error) {
                    console.log(error);
                    showAlert(error);
                });
        }, 100);
    }

    function snapshot() {
        fetch('/snapshot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    class KnobController {
        constructor(knobId, textId, commandPrefix, minRange, maxRange) {
            this.knob = document.getElementById(knobId);
            this.knobText = document.getElementById(textId);
            this.commandPrefix = commandPrefix;
            this.minRange = minRange;
            this.maxRange = maxRange;
            this.isDragging = false;
            this.previousAngle = 0;
            this.currentRotation = 0;
            this.lastSentTime = 0;
            this.throttleTimeout = null;
            this.throttleTime = 500;

            // Determine direction of mapping
            this.isReversed = minRange > maxRange;
            this.lowerBound = this.isReversed ? maxRange : minRange;
            this.upperBound = this.isReversed ? minRange : maxRange;

            this.initializeEventListeners();
        }

        getAngle(x, y, centerX, centerY) {
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
        }

        onStart(event) {
            this.isDragging = true;
            const rect = this.knob.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            this.previousAngle = this.getAngle(clientX, clientY, centerX, centerY);
        }

        onMove(event) {
            if (!this.isDragging) return;

            const rect = this.knob.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;

            const currentAngle = this.getAngle(clientX, clientY, centerX, centerY);
            let angleDiff = currentAngle - this.previousAngle;

            if (angleDiff > 180) angleDiff -= 360;
            if (angleDiff < -180) angleDiff += 360;

            this.currentRotation += angleDiff;
            this.currentRotation = Math.max(-180, Math.min(180, this.currentRotation));

            // Map the rotation (-180 to 180) to the custom range
            const rangeSpan = this.upperBound - this.lowerBound;
            let normalizedRotation = (this.currentRotation + 180) / 360; // 0 to 1

            // Apply mapping based on direction
            let displayValue;
            if (this.isReversed) {
                displayValue = Math.round(
                    this.upperBound - (normalizedRotation * rangeSpan)
                );
            } else {
                displayValue = Math.round(
                    this.lowerBound + (normalizedRotation * rangeSpan)
                );
            }

            // Clamp the value to the actual specified range
            const clampedValue = Math.max(
                Math.min(this.minRange, this.maxRange),
                Math.min(Math.max(this.minRange, this.maxRange), displayValue)
            );

            this.knob.style.transform = `rotate(${this.currentRotation}deg)`;
            this.knobText.innerText = clampedValue;

            const newCommand = this.commandPrefix + clampedValue;
            this.throttleSendCommand(newCommand);

            this.previousAngle = currentAngle;
        }

        onEnd() {
            this.isDragging = false;
        }

        throttleSendCommand(command) {
            if (this.throttleTimeout) {
                clearTimeout(this.throttleTimeout);
            }

            const now = Date.now();
            if (now - this.lastSentTime >= this.throttleTime) {
                this.sendThrottledCommand(command);
            } else {
                this.throttleTimeout = setTimeout(() => this.sendThrottledCommand(command), this.throttleTime);
            }
        }

        async sendThrottledCommand(command) {
            if (!command) return;

            this.lastSentTime = Date.now();
            this.throttleTimeout = null;

            try {
                await testAnimationCommand(command);
            } catch (error) {
                console.error(`Error sending animation command for ${this.commandPrefix}:`, error);
            }
        }

        initializeEventListeners() {
            this.knob.addEventListener('mousedown', (e) => this.onStart(e));
            this.knob.addEventListener('touchstart', (e) => this.onStart(e));
            window.addEventListener('mousemove', (e) => this.onMove(e));
            window.addEventListener('touchmove', (e) => this.onMove(e));
            window.addEventListener('mouseup', () => this.onEnd());
            window.addEventListener('touchend', () => this.onEnd());

            this.knob.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
            this.knob.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        }
    }

    // Example usage with both normal and reversed ranges
    const knob1Controller = new KnobController('knob', 'knob-text', 'S1', 180, 0);
    const knob2Controller = new KnobController('knob2', 'knob2-text', 'S2', 140, 90);
    const knob3Controller = new KnobController('knob3', 'knob3-text', 'S3', 0, 180);

    async function testAnimationCommand(command) {
        if (!command) {
            console.log("Invalid command, stopping request: " + command);
            return;
        }

        const url = "/test-animation";
        const data = { an: command };
        const jsonData = JSON.stringify({ ...data });

        try {
            let response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: jsonData,
            });

            let text = await response.text();
            return text;
        } catch (error) {
            console.log("Fetch Error: " + error + "Sending Data: " + jsonData);
        }
    }

    function getVolume() {
        fetch('/get-volume', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                volume.value = data; // Set the value of the input field with the received data
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function getLifxEnabled() {
        fetch('/get-lifx-enabled', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                lifx_enabled = (data === 'true'); // Convert to Boolean
                setLifxCheckboxState(lifx_enabled)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }

    function setSceneChangeButtons(my_data) {
        // Clear the existing buttons (if needed)
        const sceneButtonContainer = document.getElementById("sceneButtonContainer");
        sceneButtonContainer.innerHTML = '';

        // Clear the existing buttons (if needed)
        const sceneInstructionsContainer = document.getElementById("sceneInstructionsContainer");
        sceneInstructionsContainer.innerHTML = '';

        instructions = ""

        // Loop through scene in my_data
        Object.keys(my_data).forEach((scene) => {
            // Create and add a button for the scene and add to the instructions string
            instructions += scene + ", "
            const sceneButton = document.createElement("button");
            sceneButton.textContent = scene;
            sceneButton.classList.add("mui-btn", "mui-btn--primary", "animator-action");
            sceneButton.setAttribute("data-value", scene);
            sceneButton.setAttribute("data-url", "/lights-scene");
            sceneButton.setAttribute("type", "button");
            sceneButton.addEventListener('click', function () {
                var url = sceneButton.getAttribute('data-url');
                var animation = sceneButton.getAttribute('data-value');
                var redirectUrl = sceneButton.getAttribute('data-redirect');

                // Create an object with the data to be sent in the request
                var data = {
                    an: animation,
                };

                sceneButton.setAttribute('disabled', 'true');

                // Make a POST request using fetch
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(response => response.json())
                    .then(data => {
                        colorPickerLifx.value = rgbToHex(data[0], data[1], data[2]);
                        sceneButton.removeAttribute('disabled');
                    })
                    .catch(error => {
                        sceneButton.removeAttribute('disabled');
                        console.error('Error fetching default color:', error);
                    });
            });

            // Append the topic button to the topic button container
            sceneButtonContainer.appendChild(sceneButton);
        });

        instructions = instructions.slice(0, -2);

        sceneInstructionsContainer.innerHTML = 'ZL_S_E_T_I = Lifx scene change S start E end using(' + instructions + '), time, increments';
    }

    // Get all buttons with the 'animator-action' class
    // Add click event listener to each button
    var actionButtons = document.querySelectorAll('.animator-action');
    actionButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = button.getAttribute('data-url');
            var animation = button.getAttribute('data-value');
            var redirectUrl = button.getAttribute('data-redirect');

            // Create an object with the data to be sent in the request
            var data = {
                an: animation,
            };

            button.setAttribute('disabled', 'true')

            // Make a POST request using fetch
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    // Handle the response from the server
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        button.removeAttribute('disabled');
                    }
                })
                .catch(function (error) {
                    button.removeAttribute('disabled');
                    showAlert('Try Again');
                });
        });
    });

    // Get all buttons with the 'animator-light-update' class
    // Add click event listener to each button
    var lightUpdateButtons = document.querySelectorAll('.animator-light-update');
    lightUpdateButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = this.getAttribute('data-url');
            var action = this.getAttribute('data-action');
            var data = {}
            if (action == "save" || action == "clear" || action == "defaults") {
                var lightStringElement = document.getElementById('lightString');
                lightStringValue = lightStringElement.value
                if (action == "defaults") lightStringValue = "projector-1, concession-6, sign-4"
                if (action == "clear") lightStringValue = ""
                data = {
                    text: lightStringValue,
                    action: action
                }
            } else {
                data = {
                    text: action,
                    action: action
                }
            }
            button.setAttribute('disabled', 'true')
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text(); // assuming the response is plain text
                })
                .then(function (data) {
                    lightString.value = data; // Set the value of the input field with the received data
                    button.removeAttribute('disabled')
                })
                .catch(function (error) {
                    console.log(error);
                    button.removeAttribute('disabled')
                });
        });
    });

    // Get all buttons with the 'animator-volume-update' class
    // Add click event listener to each button
    var volumeUpdateButtons = document.querySelectorAll('.animator-volume-update');
    volumeUpdateButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            var url = this.getAttribute('data-url');
            var action = this.getAttribute('data-action');
            data = {
                action: action
            }

            button.setAttribute('disabled', 'true')
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(function (response) {
                    return response.text(); // assuming the response is plain text
                })
                .then(function (data) {
                    volume.value = data; // Set the value of the input field with the received data
                    button.removeAttribute('disabled')
                })
                .catch(function (error) {
                    console.log(error);
                    button.removeAttribute('disabled')
                });
        });
    });

    // Add click event listener to website submit button
    var websiteSubmitButton = document.getElementById('websiteSubmitButton');
    websiteSubmitButton.addEventListener('click', function () {
        var settingsWebsiteUrl = document.getElementById('settingsWebsiteUrl');
        var websiteUrlText = settingsWebsiteUrl.value;
        var url = this.getAttribute('data-url');

        var data = {
            text: websiteUrlText,
        };

        websiteSubmitButton.setAttribute('disabled', 'true')

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                settingsWebsiteUrl.value = data; // Set the value of the input field with the received data
                websiteSubmitButton.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                websiteSubmitButton.removeAttribute('disabled')
            });
    });

    // Restrict input to letters, numbers, and hyphens only
    settingsWebsiteUrl.addEventListener('input', function () {
        var validatedValue = this.value.replace(/[^a-zA-Z0-9-]/g, '');
        this.value = validatedValue;
    });

    // Global variables to store number of rows and data
    var globalPasteTableNumRows = 0;
    var globalPasteTable = [];
    var globalRowIndex = 0; // Index for data

    function pasteRowsAndResetTable() {
        var pasteIndex = 0;

        var rows = Array.from(dataTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null;
                return cellValue;
            });
            return values;
        });

        console.log(globalPasteTable);
        console.log(data);

        // First mutate the data
        while (globalRowIndex < data.length && pasteIndex < globalPasteTable.length) {
            // Replace data[globalRowIndex][2] with the item from globalPasteTable
            data[globalRowIndex][2] = globalPasteTable[pasteIndex];
            globalRowIndex++; // Move to the next row in data
            pasteIndex++; // Move to the next item in globalPasteTable
        }

        // Now combine the data into combinedData
        const combinedData = data.map(function (row) {
            var secondsConverted = convertTimeCodeToSeconds(row[1]);
            return secondsConverted + "|" + (row[2] || ""); // Ensure a fallback in case row[2] is undefined
        });

        console.log(combinedData);

        // Populate the table with the combined data
        populateTable(combinedData);
    }



    function animationCellClicked(event) {
        var clickedRow = event.target.closest('tr'); // This gets the <tr> element directly
        globalRowIndex = Array.prototype.indexOf.call(clickedRow.parentNode.children, clickedRow);
        console.log("Row Index:", globalRowIndex);
    }

    function editPasteTableDialog() {
        var modalEl = document.getElementById("modalEl");
        removeChildNodes(modalEl);
        modalEl.style.width = '400px';
        modalEl.style.height = 'auto';
        modalEl.style.margin = '100px auto';
        modalEl.style.backgroundColor = '#fff';

        // Create form
        var form = document.createElement('form');
        form.className = 'mui-form';
        form.style.padding = '20px';
        form.style.margin = '20px';

        var legend = document.createElement('legend');
        legend.textContent = 'Paste table';
        form.appendChild(legend);

        // Input for number of rows
        var numberRowsInput = document.createElement('div');
        numberRowsInput.className = 'mui-textfield';
        numberRowsInput.innerHTML = '<input type="number" id="numRows" placeholder="Number of rows" min="1" />';
        form.appendChild(numberRowsInput);

        // Button to generate the table
        var generateBtn = document.createElement('button');
        generateBtn.type = 'button';
        generateBtn.className = 'mui-btn mui-btn--primary';
        generateBtn.textContent = 'Generate Table';
        generateBtn.addEventListener('click', generateTable);
        form.appendChild(generateBtn);

        // Container for the table
        var tableContainer = document.createElement('div');
        tableContainer.id = 'tableContainer';
        form.appendChild(tableContainer);

        // Save button
        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'mui-btn mui-btn--primary';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', function () {
            var data = collectTableData();
            globalPasteTable = data; // Save data globally
            globalPasteTableNumRows = data.length; // Save the number of rows globally
            mui.overlay('off', modalEl); // Close modal after saving
        });
        form.appendChild(saveBtn);

        // Clear button
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'mui-btn mui-btn--secondary';
        clearBtn.textContent = 'Clear';
        clearBtn.addEventListener('click', function () {
            clearTableData(); // Clear input values but keep the table structure
        });
        form.appendChild(clearBtn);

        // Cancel button
        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'mui-btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.addEventListener('click', function () {
            mui.overlay('off', modalEl);
        });
        form.appendChild(cancelBtn);

        modalEl.appendChild(form);

        // Show modal
        mui.overlay('on', modalEl);

        // Populate fields if there's existing data
        document.getElementById('numRows').value = globalPasteTableNumRows;
        if (globalPasteTableNumRows > 0) {
            generateTable(globalPasteTable); // Generate the table with existing data
        }

        // Function to generate the table
        function generateTable(data) {
            var numRows = parseInt(document.getElementById('numRows').value, 10) || globalPasteTableNumRows;
            var tableContainer = document.getElementById('tableContainer');
            removePasteTableChildNodes(tableContainer); // Clear existing table if any

            if (numRows > 0) {
                var table = document.createElement('table');
                table.className = 'mui-table';
                // Create rows
                for (var i = 0; i < numRows; i++) {
                    var row = table.insertRow();
                    var myCell = row.insertCell(0);
                    myCell.style.padding = '0';
                    var textFieldDiv = document.createElement('div');
                    textFieldDiv.className = 'mui-textfield';
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Enter value';
                    input.value = data[i] || ''; // Populate with existing data if available
                    textFieldDiv.appendChild(input);
                    myCell.appendChild(textFieldDiv);
                }

                tableContainer.appendChild(table);
            } else {
                showAlert("Please enter a valid number of rows.");
            }
        }

        // Function to collect data from the table
        function collectTableData() {
            var table = document.querySelector('#tableContainer table');
            var data = [];

            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    var rowData = table.rows[i].cells[0].querySelector('input').value;
                    data.push(rowData);
                }
            }

            return data;
        }

        // Function to clear input values from the table
        function clearTableData() {
            var table = document.querySelector('#tableContainer table');
            if (table) {
                for (var i = 0; i < table.rows.length; i++) {
                    table.rows[i].cells[0].querySelector('input').value = '';
                }
            }
        }
    }

    // Helper function to remove all child nodes from an element
    function removePasteTableChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    function removeChildNodes(myDiv) {
        // Remove all child nodes
        while (myDiv.firstChild) {
            myDiv.removeChild(myDiv.firstChild);
        }
        // Remove all event listeners attached to the div
        const clonedDiv = myDiv.cloneNode(true);
        myDiv.parentNode.replaceChild(clonedDiv, myDiv);
    }


    function showAlert(message) {
        var alertModal = document.createElement('div');
        alertModal.className = 'mui-container';
        alertModal.style.width = '400px';
        alertModal.style.margin = '100px auto'; // Center horizontally with top margin
        alertModal.style.backgroundColor = '#fff';
        alertModal.style.borderRadius = '5px';
        alertModal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';

        alertModal.innerHTML = `
            <div class="mui-form" style="padding: 20px;">
                <legend style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Alert</legend>
                <div style="margin: 10px 0; font-size: 1em; color: #333;">
                    ${message}
                </div>
                <button class="mui-btn mui-btn--primary" onclick="closeAlert()" style="margin-top: 15px;">OK</button>
            </div>`;

        mui.overlay('on', alertModal);
    }


    function closeAlert() {
        mui.overlay('off');
    }

    // Table component
    var saveDataButton = document.getElementById("saveDataButton");
    var stopButton = document.getElementById("stopButton");
    var dataTable = document.getElementById("dataTable");
    var dataTableBody = document.querySelector("#dataTable tbody");
    var deletePlaylistButton = document.getElementById("deletePlaylistButton");


    stopButton.addEventListener("click", function () {
        stopAnimation();
    });

    saveDataButton.addEventListener("click", function () {
        saveData(animationName.value, false);
    });

    function stopAnimation() {
        stopButton.setAttribute("disabled", "true");

        var data = {
            an: animationName.value,
        };

        fetch("/stop", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                console.log("file deleted")
                stopButton.removeAttribute('disabled')
            })
            .catch(function (error) {
                console.log(error);
                stopButton.removeAttribute('disabled')
            });
    }

    function deletePlaylist() {
        var data = {
            fn: animationName.value,
        };

        fetch("/delete-playlist", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text(); // assuming the response is plain text
            })
            .then(function (data) {
                updatePlaylists()
                console.log("file deleted")
                var modalEl = document.getElementById("modalEl")
                mui.overlay('off', modalEl)
            })
            .catch(function (error) {
                console.log(error);
                showAlert(error);
            });
    }



    function populateTable(data) {
        // Clear existing table rows
        dataTableBody.innerHTML = "";

        // Populate table with new data
        data.forEach(function (rowData, index) {
            var row = createDataRow(rowData, index);
            dataTableBody.appendChild(row);
        });
    }

    dataTableBody.addEventListener("click", function (event) {
        var target = event.target;
        if (target.classList.contains("insert-row-btn")) {
            insertRow(target.parentNode.parentNode);
        } else if (target.classList.contains("delete-row-btn")) {
            deleteRow(target.parentNode.parentNode);
        } else if (target.classList.contains("add-row-btn")) {
            addRow(target.parentNode.parentNode);
        } else if (target.classList.contains("test-row-btn")) {
            testAnimation(target)
        }
    });

    function testAnimation(target) {
        const rowElement = target.parentNode.parentNode;
        const thirdInput = getTextOfInput(rowElement, 3);
        target.setAttribute("disabled", "true");
        var url = "/test-animation";

        var data = {
            an: thirdInput,
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(function (response) {
                return response.text();
            })
            .then(function (data) {
                console.log(data);
                target.removeAttribute('disabled')
            })
            .catch(function (error) {
                target.removeAttribute('disabled')
                console.log(error);
                showAlert(error);
            });
    }

    function getTextOfInput(rowElement, elNum) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            return inputElements[elNum - 1].value;
        } else {
            return "";
        }
    }

    function setTextOfInput(rowElement, elNum, textVal) {
        const inputElements = rowElement.querySelectorAll('input');
        if (inputElements.length >= elNum) {
            inputElements[elNum - 1].value = textVal;
        }
    }


    function timeSecondsCellChanged(event) {
        var inputValue = convertSecondsToTimeCode(event.target.value);
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 2, inputValue);
    }

    function timeCodeCellChanged(event) {
        var inputValue = convertTimeCodeToSeconds(event.target.value)
        setTextOfInput(event.target.parentNode.parentNode.parentNode, 1, inputValue);
    }

    function createDataRow(rowData, rowIndex) {
        var row = document.createElement("tr");
        myRowDataSplit = rowData.split("|")

        if (myRowDataSplit[0]) {
            var tsCell = createEditableCell(myRowDataSplit[0], "80px");
            tsCell.addEventListener('keydown', function (event) {
                if (event.keyCode === 13) {
                    timeSecondsCellChanged(event);
                }
            });
        } else {
            var tsCell = createEditableCell("", "80px");
        }
        row.appendChild(tsCell);

        if (myRowDataSplit[0]) {
            var timeCode = convertSecondsToTimeCode(myRowDataSplit[0])
            var tcCell = createEditableCell(timeCode, "110px");
            tcCell.addEventListener('keydown', function (event) {
                if (event.keyCode === 13) {
                    timeCodeCellChanged(event);
                }
            });

        } else {
            var tcCell = createEditableCell("", "110px");
        }
        row.appendChild(tcCell);

        if (myRowDataSplit[1]) {
            var anCell = createEditableCell(myRowDataSplit[1], "500px");
            anCell.addEventListener('click', function (event) {
                animationCellClicked(event);
            });
        } else {
            var anCell = createEditableCell("", "500px");
            anCell.addEventListener('click', function (event) {
                animationCellClicked(event);
            });
        }
        row.appendChild(anCell);

        var actionCell = document.createElement("td");
        actionCell.style.paddingTop = "0px";  // Adjust top padding
        actionCell.style.paddingBottom = "0px";  // Adjust bottom padding

        var testButton = createTestButton();
        actionCell.appendChild(testButton);

        var insertButton = createInsertButton();
        actionCell.appendChild(insertButton);

        var addButton = createAddButton();
        actionCell.appendChild(addButton);

        var deleteButton = createDeleteButton();
        actionCell.appendChild(deleteButton);

        row.appendChild(actionCell);

        return row;
    }

    function createEditableCell(value, widthVal) {
        var cell = document.createElement("td");
        cell.style.paddingTop = "0px";  // Adjust top padding
        cell.style.paddingBottom = "0px";  // Adjust bottom padding
        var input = document.createElement("input");
        input.type = "text";
        input.className = "pure-input-rounded";
        input.value = value;
        input.style.width = widthVal
        input.style.whiteSpace = "pre-wrap";
        input.style.overflow = "visible";
        var div = document.createElement("div");
        div.className = "mui-textfield";
        div.appendChild(input);
        cell.appendChild(div);
        return cell;
    }

    function createTestButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary test-row-btn";
        button.innerHTML = 'Tst';
        return button;
    }

    function createDeleteButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary delete-row-btn";
        button.innerHTML = 'Del';
        return button;
    }

    function createInsertButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary insert-row-btn";
        button.innerHTML = 'Ins';
        return button;
    }

    function createAddButton() {
        var button = document.createElement("button");
        button.type = "button";
        button.className = "mui-btn mui-btn--primary add-row-btn";
        button.innerHTML = 'Add';
        return button;
    }

    function deleteRow(row) {
        row.parentNode.removeChild(row);
        copyAndResetTable();
    }

    function addRow(row) {
        var newRow = createDataRow("|");
        dataTableBody.insertBefore(newRow, row.nextSibling);
        copyAndResetTable();
    }

    function insertRow(row) {
        var newRow = createDataRow("|");
        dataTableBody.insertBefore(newRow, row);
        copyAndResetTable();
    }

    function copyAndResetTable() {
        var rows = Array.from(dataTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null
                return cellValue;
            });
            return values;
        });

        combinedData = []

        for (let i = 0; i < data.length; i++) {
            var secondsConverted = convertTimeCodeToSeconds(data[i][1])
            combinedData.push(secondsConverted + "|" + data[i][2])
        }

        populateTable(combinedData)
    }


    function saveData(file_name, get_changes) {
        saveDataButton.setAttribute("disabled", "true");
        var rows = Array.from(dataTableBody.querySelectorAll("tr"));

        // Extract data from table rows
        var data = rows.map(function (row) {
            var cells = Array.from(row.querySelectorAll("td"));
            var values = cells.map(function (cell) {
                const cellValue = cell.querySelector("input") ? cell.querySelector("input").value : null
                return cellValue;
            });
            return values;
        });

        combinedData = []

        for (let i = 0; i < data.length; i++) {
            var secondsConverted = convertTimeCodeToSeconds(data[i][1])
            combinedData.push(secondsConverted + "|" + data[i][2])
        }

        const blockSize = 5;
        const totalBlocks = Math.ceil(combinedData.length / blockSize);

        // Function to send each block sequentially
        function sendBlockSequentially(index) {
            if (index >= totalBlocks) {
                if (get_changes == true) {
                    updatePlaylists()
                    var modalEl = document.getElementById("modalEl")
                    mui.overlay('off', modalEl)
                }
                // All blocks have been sent, enable the button
                saveDataButton.removeAttribute('disabled');
                return;
            }

            const startIdx = index * blockSize;
            const endIdx = Math.min((index + 1) * blockSize, combinedData.length);
            const block = combinedData.slice(startIdx, endIdx);
            let myObject = [index, totalBlocks - 1, block]
            if (index == totalBlocks - 1) {
                myObject = [index, totalBlocks - 1, block, file_name]
            }

            // Send data to the server
            fetch("/save-data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(myObject)
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Error saving data. Please try again.");
                    }
                    // Send the next block sequentially
                    sendBlockSequentially(index + 1);
                })
                .catch(function (error) {
                    saveDataButton.removeAttribute('disabled');
                    console.log(error);
                    showAlert(error);
                });
        }

        // Start sending blocks sequentially
        sendBlockSequentially(0);
    }

    // Function to convert DaVinci Resolve timestamp to seconds
    function convertTimeCodeToSeconds(timestamp) {
        var parts = timestamp.split(':');
        var hours = parseInt(parts[0]);
        var minutes = parseInt(parts[1]);
        var seconds = parseInt(parts[2]);
        var frames = parseInt(parts[3]);

        hours -= 1

        var totalSeconds = hours * 3600 + minutes * 60 + seconds + frames / 24;

        if (!totalSeconds) totalSeconds = 0;

        return totalSeconds.toFixed(1);
    }

    // Function to convert seconds to DaVinci Resolve timestamp
    function convertSecondsToTimeCode(seconds) {
        var hours = Math.floor(seconds / 3600) + 1;
        seconds %= 3600;
        var minutes = Math.floor(seconds / 60);
        seconds %= 60;
        var frames = Math.round((seconds - Math.floor(seconds)) * 24);

        if (!seconds) {
            hours = 1
            minutes = 0
            frames = 0
        }

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(Math.floor(seconds)).padStart(2, '0')}:${String(frames).padStart(2, '0')}`;
    }

    const colorPickerLifx = document.getElementById('colorPickerLifx');
    colorPickerLifx.addEventListener('input', function () {
        const color = colorPickerLifx.value;
        const rgb = hexToRgb(color);
        // Send RGB values to the server only if no request is in progress
        if (!isRequestInProgress) {
            isRequestInProgress = true;
            sendRGBValues("lifx", rgb.r, rgb.g, rgb.b);
        }
    });

    const colorPickerNeo = document.getElementById('colorPickerNeo');
    colorPickerNeo.addEventListener('input', function () {
        const color = colorPickerNeo.value;
        const rgb = hexToRgb(color);
        // Send RGB values to the server only if no request is in progress
        if (!isRequestInProgress) {
            isRequestInProgress = true;
            sendRGBValues("neo", rgb.r, rgb.g, rgb.b);
        }
    });

    // Add click event listener to file input button
    document.getElementById('fileInput').addEventListener('change', function () {
        if (this.files.length > 0) {
            document.getElementById('status').innerText = '';
            const percentComplete = (event.loaded / event.total) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentComplete + '%';
            progressBar.innerText = percentComplete.toFixed(2) + '%';
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = percentComplete + '%';
                    progressBar.innerText = percentComplete.toFixed(2) + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    document.getElementById('status').innerText = 'File uploaded successfully!';
                    document.getElementById('progressBar').style.backgroundColor = '#4caf50';
                } else {
                    document.getElementById('status').innerText = 'File upload failed!';
                    document.getElementById('progressBar').style.backgroundColor = '#f44336';
                }
            };

            xhr.onerror = function () {
                document.getElementById('status').innerText = 'File upload failed!';
                document.getElementById('progressBar').style.backgroundColor = '#f44336';
            };

            xhr.send(formData);
        }
    })

    function hexToRgb(hex) {
        hex = hex.replace(/^#/, '');
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return { r, g, b };
    }

    function rgbToHex(r, g, b) {
        return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1).toUpperCase()}`;
    }

    function sendRGBValues(item, r, g, b) {
        console.log(r)
        console.log(g)
        console.log(b)
        const endpoint = "/set-item-lights";
        const data = {
            item: item,
            r: r,
            g: g,
            b: b
        };

        fetch(endpoint, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.text())
            .then(data => {
                console.log(data)
                isRequestInProgress = false; // Reset the flag after the request is completed
            })
            .catch(error => {
                console.error('Error:', error)
                isRequestInProgress = false; // Reset the flag in case of an error
            });
    }

    // Function to enable or disable elements in lifxDiv
    function toggleLifxDiv() {
        const isChecked = document.getElementById("lifxCheckbox").checked;
        const lifxDiv = document.getElementById("lifxDiv");
        lifxDiv.style.display = isChecked ? "block" : "none";
    }




    // Function to change checkbox state programmatically
    function setLifxCheckboxState(newState) {
        programmaticChange = true;
        lifxCheckbox.checked = newState;
        toggleLifxDiv()
        programmaticChange = false;
    }


    // Combined event listener for checkbox change
    lifxCheckbox.addEventListener('change', function () {
        // Skip fetch request if this is a programmatic change
        if (programmaticChange) return;

        const url = this.getAttribute('data-url');
        const isChecked = this.checked;

        toggleLifxDiv()

        const data = {
            enabled: isChecked
        };

        lifxCheckbox.setAttribute('disabled', 'true');
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.text())
            .then(data => {
                console.log('Response:', data);
                lifxCheckbox.removeAttribute('disabled');
            })
            .catch(error => {
                console.log(error);
                lifxCheckbox.removeAttribute('disabled');
            });
    });

    function makeSocketConnection(settingsWebsiteUrl) {
        const cfg = {
            "HOST_NAME": settingsWebsiteUrl
        };

        const server_str = `${cfg["HOST_NAME"]}.local`; // Adjust as needed
        const websocketUrl = `ws://${server_str}:8001`; // Ensure this matches your server setup

        const queueList = document.getElementById('queueList');
        const socket = new WebSocket(websocketUrl);

        const currentMedia = document.getElementById('currentMedia');

        socket.onopen = function (event) {
            console.log('WebSocket connection established.');
        };

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            // console.log("Received data:", data);  // Log received data for debugging
            currentMedia.innerHTML = '';
            const pElement = document.createElement('p');
            pElement.textContent = "Playing: " + data.current_media_playing;
            currentMedia.appendChild(pElement);
            updateQueue(data.commands);
        };

        socket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        socket.onclose = function (event) {
            console.log('WebSocket connection closed:', event);
        };

        function updateQueue(commands) {
            // Clear the current list
            queueList.innerHTML = '';
            // Populate the list with new queue items
            commands.forEach(command => {
                const listItem = document.createElement('li');
                listItem.className = 'MuiListItem-root MuiListItem-gutters MuiListItem-button';
                listItem.textContent = command; // Assuming each command is a string
                queueList.appendChild(listItem);
            });
        }
    }

    // Video recording code

    const streamImg = document.getElementById('stream');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const videoPlayer = document.getElementById('videoPlayer');
    const thumbnailGallery = document.getElementById('thumbnailGallery');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    const setZoomBtn = document.getElementById('setZoomBtn');
    const focusSlider = document.getElementById('focusSlider');
    const focusValue = document.getElementById('focusValue');


    let canvas, ctx, mediaRecorder, recordedChunks = [];
    let recordings = [];
    const blobUrlMap = new Map();

    function throttle(func, limit) {
        let lastCall = 0;
        return function (...args) {
            const now = Date.now();
            if (now - lastCall >= limit) {
                lastCall = now;
                return func.apply(this, args);
            }
        };
    }

    async function setZoom(zoomFactor) {
        try {
            const response = await fetch('/set-zoom', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ zoom: zoomFactor }) });
            if (response.ok) console.log(`Zoom set to ${zoomFactor}x`);
            else console.error('Failed to set zoom:', response.status);
        } catch (e) { console.error('Error setting zoom:', e); }
    }

    async function setFocus(focusValue) {
        try {
            const response = await fetch('/set-focus', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ focus: focusValue }) });
            if (response.ok) console.log(`Focus set to ${focusValue}`);
            else console.error('Failed to set focus:', response.status);
        } catch (e) { console.error('Error setting focus:', e); }
    }


    const throttledSetZoom = throttle(setZoom, 200);
    const throttledSetFocus = throttle(setFocus, 200);

    zoomSlider.addEventListener('input', () => { const zoom = parseFloat(zoomSlider.value); zoomValue.textContent = `${zoom}x`; throttledSetZoom(zoom); });
    zoomSlider.addEventListener('change', () => { const zoom = parseFloat(zoomSlider.value); setZoom(zoom); });
    zoomSlider.addEventListener('touchend', () => { const zoom = parseFloat(zoomSlider.value); setZoom(zoom); });


    focusSlider.addEventListener('input', () => { const focus = parseFloat(focusSlider.value); focusValue.textContent = focus; throttledSetFocus(focus); });
    focusSlider.addEventListener('change', () => { const focus = parseFloat(focusSlider.value); setFocus(focus); });
    focusSlider.addEventListener('touchend', () => { const focus = parseFloat(focusSlider.value); setFocus(focus); });


    function setupCanvas() {
        canvas = document.createElement('canvas');
        canvas.width = streamImg.naturalWidth || 1280;
        canvas.height = streamImg.naturalHeight || 720;
        ctx = canvas.getContext('2d');
        console.log('Canvas setup with dimensions:', canvas.width, 'x', canvas.height);
    }

    async function generateThumbnail(videoBlob) {
        return new Promise((resolve, reject) => {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            video.src = URL.createObjectURL(videoBlob);
            video.muted = true;
            video.currentTime = 1;
            video.onloadeddata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const thumbnailDataUrl = canvas.toDataURL('image/jpeg');
                URL.revokeObjectURL(video.src);
                resolve(thumbnailDataUrl);
            };
            video.onerror = (e) => reject(e);
        });
    }

    async function validateBlob(blob) {
        return new Promise((resolve, reject) => {
            const video = document.createElement('video');
            const url = URL.createObjectURL(blob);
            video.src = url;
            video.onloadedmetadata = () => {
                console.log('Blob validation: Metadata loaded. Duration:', video.duration, 'Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                URL.revokeObjectURL(url);
                resolve(true);
            };
            video.onerror = (e) => {
                console.error('Blob validation: Error loading video:', e);
                URL.revokeObjectURL(url);
                reject(e);
            };
        });
    }

    async function addRecordingToGallery(recording, fileExtension) {
        const thumbnailImg = document.createElement('img');
        thumbnailImg.className = 'thumbnail';
        thumbnailImg.src = recording.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';
        thumbnailImg.dataset.recordingId = recording.id;
        thumbnailImg.title = `Recording ${new Date(parseInt(recording.id)).toLocaleString()}`;

        thumbnailImg.addEventListener('click', async () => {
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnailImg.classList.add('active');
            const blobUrl = URL.createObjectURL(recording.blob);
            blobUrlMap.set(recording.id, blobUrl);
            console.log('Created blob URL for playback:', blobUrl);
            videoPlayer.src = blobUrl;
            videoPlayer.play().catch(e => console.error('Error playing video:', e));
            downloadBtn.disabled = false;
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = `recording-${recording.id}.${fileExtension}`; // Use dynamic extension
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
        });

        thumbnailGallery.appendChild(thumbnailImg);
    }

    async function saveRecording(blob, recordingId, fileExtension) {
        console.log('Saving recording - Blob size:', blob.size, 'Blob type:', blob.type);
        try {
            await validateBlob(blob);
            console.log('Blob validated successfully');
            const thumbnailDataUrl = await generateThumbnail(blob);
            const recording = {
                id: recordingId,
                blob: blob,
                thumbnail: thumbnailDataUrl
            };
            recordings.push(recording);
            await addRecordingToGallery(recording, fileExtension); // Pass fileExtension
        } catch (e) {
            console.error('Error processing recording:', e);
            showAlert('Failed to process recording. Check the console for details.');
        }
    }

    function startRecording() {
        if (!canvas) setupCanvas();
        recordedChunks = [];

        const stream = canvas.captureStream(30); // 30 FPS

        // Prioritize MP4, fall back to WebM
        let mimeType = 'video/mp4; codecs=avc1.42001E'; // H.264 baseline profile
        let fileExtension = 'mp4';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
            console.warn(`MIME type ${mimeType} not supported, falling back to WebM`);
            mimeType = 'video/webm; codecs=vp8';
            fileExtension = 'webm';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                console.error('No supported video format found');
                showAlert('No supported video format available. Check the console.');
                return;
            }
        }
        console.log('Selected MIME type:', mimeType);
        console.log('File extension:', fileExtension);

        try {
            mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
            console.log('MediaRecorder created with MIME type:', mediaRecorder.mimeType);
        } catch (e) {
            console.error('Error creating MediaRecorder:', e);
            showAlert('Failed to start recording. Check the console.');
            return;
        }

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
                console.log('Data available:', event.data.size, 'bytes', 'Type:', event.data.type);
            }
        };

        mediaRecorder.onstop = async () => {
            console.log('MediaRecorder stopped. Total chunks:', recordedChunks.length);
            await new Promise(resolve => setTimeout(resolve, 100));
            const blob = new Blob(recordedChunks, { type: mimeType });
            console.log('Blob created:', blob.size, 'bytes', 'Type:', blob.type);

            const recordingId = Date.now();
            await saveRecording(blob, recordingId, fileExtension);
            startBtn.disabled = false;
            stopBtn.disabled = true;
            downloadBtn.disabled = true;
        };

        mediaRecorder.onerror = e => console.error('MediaRecorder error:', e);

        function drawToCanvas() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                ctx.drawImage(streamImg, 0, 0, canvas.width, canvas.height);
                requestAnimationFrame(drawToCanvas);
            }
        }

        try {
            mediaRecorder.start();
            console.log('Recording started');
            drawToCanvas();
        } catch (e) {
            console.error('Error starting recording:', e);
            showAlert('Failed to start recording. Check the console.');
            return;
        }

        startBtn.disabled = true;
        stopBtn.disabled = false;
        downloadBtn.disabled = true;
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            console.log('Stop requested');
        } else {
            console.warn('No active recording to stop');
        }
    }

    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    streamImg.onload = () => {
        console.log('MJPEG stream loaded. Dimensions:', streamImg.naturalWidth, 'x', streamImg.naturalHeight);
        if (!canvas) setupCanvas();
    };



    streamImg.onerror = () => {
        console.error('Error loading MJPEG stream');
        streamStatus.textContent = 'Streaming stopped. Press start stream to continue streaming.';
    };

    window.addEventListener('unload', () => {
        if (videoPlayer.src) URL.revokeObjectURL(videoPlayer.src);
        blobUrlMap.forEach(url => URL.revokeObjectURL(url));
        recordings.forEach(recording => URL.revokeObjectURL(recording.thumbnail));
    });


</script>

</html>